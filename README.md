# Fw - Android ä¿æ´»æ¡†æ¶

<div align="center">

![èŒèŒè®¡æ•°å™¨](https://count.getloli.com/get/@KeepLiveService?theme=rule34)

<p>
  <b>ğŸŒŸ å¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹å‡» <a href="https://github.com/Pangu-Immortal/KeepLiveService/stargazers">Star</a> æ”¯æŒä¸€ä¸‹ï¼Œå…³æ³¨ä¸è¿·è·¯ï¼ğŸŒŸ</b>
</p>

[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/Platform-Android-green.svg)](https://developer.android.com)
[![API](https://img.shields.io/badge/API-24%2B-brightgreen.svg)](https://android-arsenal.com/api?level=24)
[![Kotlin](https://img.shields.io/badge/Kotlin-2.2.21-purple.svg)](https://kotlinlang.org)
[![16K Page Size](https://img.shields.io/badge/16K%20Page%20Size-Compatible-orange.svg)](https://developer.android.com/guide/practices/page-sizes)
[![Google Play](https://img.shields.io/badge/Google%20Play-Ready-success.svg)](https://developer.android.com/distribute/best-practices/develop/64-bit)

</div>

> å®‰å…¨ç ”ç©¶ç”¨é€”ï¼šå®Œæ•´å¤ç°å¸‚é¢ä¸Šæ‰€æœ‰çš„ä¿æ´»æœºåˆ¶ï¼Œç©·å°½å±•ç¤ºæ‰€æœ‰ä¿æ´»æ‰‹æ®µï¼Œé€‚é…æ‰€æœ‰çš„ä¸»æµæœºå‹å’Œ ROMã€‚
> 
> ä¸ºäº†æ‹‰é½å…¨ç½‘å…±åŒè®¤çŸ¥ï¼Œè®©å°å›¢é˜Ÿå¼€å‘ä¸åœ¨è¿·èŒ«ï¼Œå¼€æºäº†å…¨å¥—æ‰€æœ‰ç§å¯†å‡½æ•°å’Œç§å¯†ç­–ç•¥ã€‚ä¼šé•¿æœŸæŒç»­è¿­ä»£ï¼Œä¼šé™†é™†ç»­ç»­çš„å…¬å¼€æ‰€æœ‰çš„éšç§ç­–ç•¥ï¼Œecpm ç­–ç•¥ç­‰ç­‰ï¼Œæ¬¢è¿ starğŸŒŸ æŒç»­å…³æ³¨ã€‚
> 
> æ›´å¤šè¯¦ç»†å†…å®¹ï¼Œå¯ä»¥æŸ¥é˜…é¡¹ç›®ï¼šhttps://github.com/Pangu-Immortal/KeepAlivePerfect

ğŸ”¥ **Telegram ç¾¤ç»„**ï¼š [ç‚¹å‡»åŠ ç¾¤è®¨è®ºï¼Œè¿™é‡Œåªæ˜¯å†°å±±ä¸€è§’ã€‚](https://t.me/+V7HSo1YNzkFkY2M1)

Tipsï¼š
æœ‰å¤§é‡çš„äººç»™æˆ‘ç•™è¨€ï¼Œè®©æˆ‘å…³æ‰è¿™å‡ ä¸ªå¼€æºåº“ï¼Œè¿˜è¯´ç»´æŠ¤è¿™ä¸ªæ–¹å‘çš„æŠ€æœ¯â€œä¸æ˜¯äººâ€ï¼Œè¿˜æœ‰äººå¼ å£é—­å£å°±æ˜¯â€œç•œç”Ÿâ€ï¼Œâ€œä¸€ä¸ªäººç ´åäº†æ•´ä¸ª Android è¡Œä¸šâ€ï¼Œâ€œAndroid ç”Ÿæ€æœ¬æ¥è¿˜æœ‰æœ¬ä»½åšçš„ï¼Œè¿™ä¸‹éƒ½çŸ¥é“åŸæ¥åˆ«äººéƒ½ä¸å¥½å¥½åšï¼Œè¡Œä¸šå½»åº•ä¹±äº†â€ï¼Œâ€œæœ¬æ¥é‚£äº›è¢«è¡Œä¸šæ·˜æ±°çš„å›¢é˜Ÿï¼Œè®©ä½ åˆæ•‘å›æ¥äº†ï¼ŒçœŸTMæ— è¯­â€ï¼Œâ€œæœ¬æ¥è‡ªå·±å·å·çš„åšæµ·å¤–ovmï¼ŒåŸºæœ¬æ²¡æœ‰ç«å¯¹ï¼ŒTMDè¿™ä¸‹å…¨æ¥æäº†â€ â€¦â€¦ 

> è¿˜æœ‰ä¸€éƒ¨åˆ†äººä¸€ç›´åœ¨åæ§½ï¼šâ€œçœ‹ä¸æ‡‚ä½œè€…ï¼Œæ ¹æœ¬æ‰¾ä¸åˆ°è”ç³»æ–¹å¼ï¼Œæ€ä¹ˆä¹Ÿè”ç³»ä¸åˆ°ä½œè€…ã€‚ä¸çŸ¥é“ä½œè€…æ€ä¹ˆå–ä»£ç çš„ã€‚â€
> æˆ‘å¦‚æœè¯´æˆ‘æ ¹æœ¬å°±ä¸å–ä»£ç å‘¢ï¼Ÿè€Œä¸”å°±ä¸æƒ³è®©é‚£ 99% çš„äººè”ç³»ä¸Šæˆ‘å‘¢ï¼Ÿèƒ½ç­›é€‰å‡º 1% çš„èªæ˜äººå°±å›å¤ä¸è¿‡æ¥äº†ã€‚
> åæ§½ä¹Ÿæ”¹å˜ä¸äº†è¿™ä¸ªåº“çš„ç»´æŠ¤ï¼Œè€Œä¸”ä¼šæŒç»­çš„è¿­ä»£ï¼Œåé¢è¿˜ä¼šæŠŠæ‰€æœ‰æš—åˆ·å¹¿å‘Šçš„ç­–ç•¥å…¨å¼€æºã€‚æ°´ä¸Šå’Œæ°´ä¸‹å‡ åç§ç”¨æˆ·æ— æ„ŸçŸ¥çš„æš—åˆ·ã€‚
> ç”¨æˆ·éƒ½æ²¡çœ‹åˆ°ï¼Œæˆ‘å·²ç»åˆ·äº†å‡ åä¸ªå¹¿å‘Šï¼Œé‚£ä¸æ¯”å¼¹å‡ºæ¥æ‰“æ‰°ç”¨æˆ·çš„å¼ºå—ï¼Ÿè°æ›´é«˜å°šï¼Ÿå¥½å¿ƒ+æ— çŸ¥æ— èƒ½=åšåäº‹ï¼Œä¿—ç§°çƒ‚å¥½äººã€‚

## é¡¹ç›®äº®ç‚¹

- **ğŸ†• é€‚é… Google Play æœ€æ–°è¦æ±‚** - å®Œå…¨å…¼å®¹ 2026 å¹´ Google Play å•†åº—çš„æ‰€æœ‰æŠ€æœ¯è¦æ±‚
- **ğŸ“± Android 16K é¡µé¢å¤§å°æ”¯æŒ** - åŸç”Ÿä»£ç å·²é€‚é… 16KB é¡µé¢å¯¹é½ï¼Œå…¼å®¹ Android 15+ çš„ 16K é¡µé¢è®¾å¤‡
- **ğŸ”§ æœ€æ–°å¼€å‘å·¥å…·é“¾** - ä½¿ç”¨ AGP 8.14.3ã€Kotlin 2.2.21ã€JDK 21ã€NDK 27 ç­‰æœ€æ–°ç¨³å®šç‰ˆå¼€å‘
- **ğŸ“¦ 64 ä½æ¶æ„å…¨è¦†ç›–** - æ”¯æŒ arm64-v8aã€armeabi-v7aã€x86_64ã€x86 å››ç§æ¶æ„
- **ğŸ›¡ï¸ ç”Ÿäº§çº§ä»£ç è´¨é‡** - é€šè¿‡ Lint æ£€æŸ¥ã€ProGuard æ··æ·†ä¼˜åŒ–ï¼Œå¯ç›´æ¥ä¸Šæ¶åº”ç”¨å•†åº—
- **ğŸµ MediaRoute ä¿æ´»æŠ€æœ¯** - é…·ç‹—éŸ³ä¹æ ¸å¿ƒä¿æ´»ç­–ç•¥ï¼Œå‘ç³»ç»Ÿæ³¨å†Œåª’ä½“è·¯ç”±è·å¾—ç‰¹æ®Šä¿æŠ¤
- **âš¡ æ— æ³•å¼ºåˆ¶åœæ­¢ç­–ç•¥** - 5ms æ—¶é—´å·®ç«äº‰æŠ€æœ¯ï¼ŒC++ ç›´æ¥è°ƒç”¨ AMS Binder

### **Star â­ è¿™ä¸ªé¡¹ç›®å¦‚æœå¯¹ä½ æœ‰å¸®åŠ©ï¼**

---

## ğŸ“š ç›®å½•

| ç« èŠ‚ | è¯´æ˜ |
| ------ | ------ |
| [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹) | æ¡†æ¶ä»‹ç»ã€ç‰¹æ€§åˆ—è¡¨ |
| [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹) | ä¸€è¡Œä»£ç åˆå§‹åŒ–ã€é…ç½®ç¤ºä¾‹ |
| [ä¿æ´»ç­–ç•¥å®Œæ•´åˆ—è¡¨](#ä¿æ´»ç­–ç•¥å®Œæ•´åˆ—è¡¨) | 25+ ç§ä¿æ´»ç­–ç•¥è¯¦è§£ |
| [å‚å•†æ¨é€é€šé“å¤ç”¨](#å‚å•†æ¨é€é€šé“å¤ç”¨é«˜çº§ç­–ç•¥) | å‚å•†æ¨é€ SDK é›†æˆ |
| [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„) | ç›®å½•ç»“æ„ã€æ¨¡å—è¯´æ˜ |
| [å‚å•†é€‚é…](#å‚å•†é€‚é…) | å„å‚å•†ç‰¹æ®Šå¤„ç†æ–¹æ¡ˆ |
| [æƒé™è¯´æ˜](#æƒé™è¯´æ˜) | Manifest æƒé™ã€è¿è¡Œæ—¶æƒé™ |
| [æ ¸å¿ƒåŸç†](#æ ¸å¿ƒåŸç†) | é…·ç‹—/å¢¨è¿¹å¤©æ°”ä¿æ´»åŸç†åˆ†æ |
| [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜) | FAQ |
| [æ›´æ–°æ—¥å¿—](#æ›´æ–°æ—¥å¿—) | ç‰ˆæœ¬å†å² |

---

## é¡¹ç›®ç®€ä»‹

Fwï¼ˆFrameworkï¼‰æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–çš„ Android ä¿æ´»æ¡†æ¶ï¼Œå¤ç°äº†æ‰€æœ‰çš„å•†ä¸šåº”ç”¨çš„åå°ä¿æ´»æŠ€æœ¯ã€‚å½“è“ç‰™è®¾å¤‡è¿æ¥ã€USB è®¾å¤‡æ’å…¥ã€NFC æ ‡ç­¾å‘ç°ç­‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå³ä½¿åº”ç”¨åœ¨åå°æˆ–è¿›ç¨‹è¢«æ€æ­»ï¼Œä¹Ÿèƒ½è‡ªåŠ¨å”¤é†’å¹¶æ¢å¤æœåŠ¡ã€‚

**ç‰¹æ€§ï¼š**

- ğŸš€ ä¸€è¡Œä»£ç åˆå§‹åŒ–
- ğŸ“¦ æ¨¡å—åŒ–è®¾è®¡ï¼Œç­–ç•¥å¯ç‹¬ç«‹å¼€å…³
- ğŸ”§ æ”¯æŒ 25+ ç§ä¿æ´»ç­–ç•¥
- ğŸ“± é€‚é… Android 7.0 - 16ï¼ˆAPI 24 - 36.1ï¼‰
- ğŸ­ æ”¯æŒä¸»æµå‚å•†ï¼ˆå°ç±³ã€åä¸ºã€OPPOã€vivoã€ä¸‰æ˜Ÿã€Googleã€ä¼ éŸ³ç­‰ï¼‰
- ğŸ”¨ åŒ…å« Native C++ å±‚ä¿æ´»
- ğŸ“Š æä¾›å‚å•†é›†æˆåˆ†æå·¥å…·

---

## å¼€å‘ç¯å¢ƒ

| é¡¹ç›® | ç‰ˆæœ¬ |
|-----|------|
| Android Studio | Android Studio Otter 2 Feature Drop 2025.2.2|
| Gradle | 8.14.3 |
| AGP (Android Gradle Plugin) | 8.14.3 |
| Kotlin | 2.2.21 |
| JVM | 21 |
| NDK | 27.0.12077973 |
| CMake | 3.22.1 |

---

## SDK ç‰ˆæœ¬

| é¡¹ç›® | ç‰ˆæœ¬                |
|-----|-------------------|
| compileSdk | 36.1 (Android 16) |
| targetSdk | 36.1              |
| minSdk | 24 (Android 7.0)  |

---

## Android ç‰ˆæœ¬é€‚é…

| Android ç‰ˆæœ¬ | API   | é€‚é…è¦ç‚¹ |
|-------------|-------|---------|
| 7.x | 24-25 | `startService()` |
| 8.0+ | 26+   | `startForegroundService()` + é€šçŸ¥æ¸ é“ï¼Œé™æ€å¹¿æ’­å—é™ |
| 9.0+ | 28+   | åå°é™åˆ¶åŠ å¼º |
| 10+ | 29+   | åå°å¯åŠ¨ Activity å—é™ |
| 11+ | 30+   | å‰å°æœåŠ¡ç±»å‹å¿…é¡»å£°æ˜ |
| 12+ | 31+   | `BLUETOOTH_CONNECT` è¿è¡Œæ—¶æƒé™ï¼Œç²¾ç¡®é—¹é’Ÿæƒé™ |
| 13+ | 33+   | `POST_NOTIFICATIONS` è¿è¡Œæ—¶æƒé™ |
| 14+ | 34+   | `FOREGROUND_SERVICE_MEDIA_PLAYBACK` æƒé™ |
| 15+ | 35+   | æ›´ä¸¥æ ¼çš„åå°é™åˆ¶ï¼Œ**16KB é¡µé¢å¤§å°è®¾å¤‡æ”¯æŒ** |
| 16 | 36.1  | æœ€æ–° API |

### Android 16K é¡µé¢å¤§å°é€‚é…

ä» Android 15 å¼€å§‹ï¼Œéƒ¨åˆ†è®¾å¤‡ä½¿ç”¨ 16KB é¡µé¢å¤§å°ï¼ˆè€Œéä¼ ç»Ÿçš„ 4KBï¼‰ã€‚æœ¬é¡¹ç›®å·²å®Œæˆ 16K é€‚é…ï¼š

**é€‚é…æ–¹å¼ï¼š**

1. **CMake é“¾æ¥é€‰é¡¹** - åœ¨ `CMakeLists.txt` ä¸­æ·»åŠ ï¼š

   ```cmake
   set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-z,max-page-size=16384")
   ```

2. **ELF æ®µå¯¹é½** - ç¼–è¯‘åçš„ Native åº“ LOAD æ®µå¯¹é½å€¼ä¸º `0x4000` (16384 = 16KB)

**éªŒè¯æ–¹æ³•ï¼š**

```bash
# ä½¿ç”¨ NDK çš„ llvm-readelf æ£€æŸ¥ ELF å¯¹é½
llvm-readelf -l libfw_native.so | grep LOAD
# è¾“å‡ºåº”æ˜¾ç¤ºå¯¹é½å€¼ä¸º 0x4000
```

**å‚è€ƒæ–‡æ¡£ï¼š** [Support 16 KB page sizes](https://developer.android.com/guide/practices/page-sizes)

---

## å¿«é€Ÿå¼€å§‹

### ä¸€è¡Œä»£ç åˆå§‹åŒ–

```kotlin
// åœ¨ Application.onCreate() ä¸­
Fw.init(this)
```

### è‡ªå®šä¹‰é…ç½®

```kotlin
Fw.init(this) {
    // ==================== åŸºç¡€ç­–ç•¥ ====================
    enableForegroundService = true      // å‰å°æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰
    enableMediaSession = true           // MediaSessionï¼ˆè®©ç³»ç»Ÿè®¤ä¸ºæ˜¯åª’ä½“åº”ç”¨ï¼‰
    enableOnePixelActivity = true       // 1åƒç´ Activity

    // ==================== å®šæ—¶å”¤é†’ç­–ç•¥ ====================
    enableJobScheduler = true           // JobScheduler
    jobSchedulerInterval = 15 * 60 * 1000L  // 15åˆ†é’Ÿ
    enableWorkManager = true            // WorkManager
    workManagerIntervalMinutes = 15L    // 15åˆ†é’Ÿ
    enableAlarmManager = true           // AlarmManager
    alarmManagerInterval = 5 * 60 * 1000L   // 5åˆ†é’Ÿ

    // ==================== è´¦æˆ·åŒæ­¥ç­–ç•¥ ====================
    enableAccountSync = true            // è´¦æˆ·åŒæ­¥
    syncIntervalSeconds = 60L           // 60ç§’

    // ==================== å¹¿æ’­ç­–ç•¥ ====================
    enableSystemBroadcast = true        // ç³»ç»Ÿå¹¿æ’­
    enableBluetoothBroadcast = true     // è“ç‰™å¹¿æ’­ï¼ˆæ ¸å¿ƒï¼šé…·ç‹—éŸ³ä¹çš„å…³é”®ï¼‰
    enableMediaButtonReceiver = true    // åª’ä½“æŒ‰é”®
    enableUsbBroadcast = true           // USB å¹¿æ’­
    enableNfcBroadcast = true           // NFC å¹¿æ’­
    enableMediaMountBroadcast = true    // åª’ä½“æŒ‚è½½å¹¿æ’­

    // ==================== å†…å®¹è§‚å¯Ÿè€…ç­–ç•¥ ====================
    enableMediaContentObserver = true   // ç›¸å†Œå˜åŒ–
    enableContactsContentObserver = false // è”ç³»äººå˜åŒ–ï¼ˆéœ€è¦æƒé™ï¼‰
    enableSmsContentObserver = false    // çŸ­ä¿¡å˜åŒ–ï¼ˆéœ€è¦æƒé™ï¼‰
    enableSettingsContentObserver = true // è®¾ç½®å˜åŒ–
    enableFileObserver = true           // æ–‡ä»¶ç³»ç»Ÿå˜åŒ–

    // ==================== åŒè¿›ç¨‹å®ˆæŠ¤ç­–ç•¥ ====================
    enableDualProcess = true            // Java åŒè¿›ç¨‹å®ˆæŠ¤

    // ==================== Native å±‚ä¿æ´» ====================
    enableNativeDaemon = true           // Native å®ˆæŠ¤è¿›ç¨‹
    nativeDaemonCheckInterval = 3000    // æ£€æŸ¥é—´éš” 3 ç§’
    enableNativeSocket = true           // Socket å¿ƒè·³
    nativeSocketName = "fw_native_socket"

    // ==================== æ— æ³•å¼ºåˆ¶åœæ­¢ç­–ç•¥ ====================
    enableForceStopResistance = false   // é»˜è®¤å…³é—­ï¼ˆä¾µå…¥æ€§å¼ºï¼Œä»… Android 5.0-12.0 æœ‰æ•ˆï¼‰

    // ==================== MediaRoute ä¿æ´»ç­–ç•¥ï¼ˆæ–°å¢ v2.2.0ï¼‰====================
    enableMediaRouteProvider = true     // MediaRouteProviderService
    enableMediaRoute2Provider = true    // MediaRoute2ProviderService (Android 11+)
    enableMediaIntentActivity = true    // åª’ä½“æ„å›¾å¤„ç† Activity

    // ==================== é«˜çº§ä¾µå…¥æ€§ç­–ç•¥ ====================
    enableLockScreenActivity = false    // é”å± Activityï¼ˆé»˜è®¤å…³é—­ï¼‰
    enableFloatWindow = false           // æ‚¬æµ®çª—ï¼ˆé»˜è®¤å…³é—­ï¼‰
    floatWindowHidden = true            // éšè—æ‚¬æµ®çª—ï¼ˆ1åƒç´ ï¼‰

    // ==================== é€šçŸ¥é…ç½® ====================
    notificationChannelId = "fw_channel"
    notificationChannelName = "å®ˆæŠ¤æœåŠ¡"
    notificationTitle = "éŸ³ä¹æ’­æ”¾ä¸­"
    notificationContent = "ç‚¹å‡»æ‰“å¼€åº”ç”¨"
    notificationIconResId = R.drawable.ic_notification
    notificationActivityClass = MainActivity::class.java

    // ==================== æ—¥å¿—é…ç½® ====================
    enableDebugLog = true
    logTag = "Fw"
}
```

### æ§åˆ¶æ–¹æ³•

```kotlin
// æ‰‹åŠ¨è§¦å‘ä¿æ´»æ£€æŸ¥
Fw.check()

// åœæ­¢æ‰€æœ‰ä¿æ´»ç­–ç•¥
Fw.stop()

// æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
Fw.isInitialized()

// é”å± Activityï¼ˆç±»ä¼¼å¢¨è¿¹å¤©æ°”çš„é”å±å¤©æ°”ï¼‰
LockScreenActivity.start(context)

// æ‚¬æµ®çª—ä¿æ´»
FloatWindowManager.showOnePixelFloat(context)  // éšè—çš„ 1 åƒç´ 
FloatWindowManager.showVisibleFloat(context)    // å¯è§çš„æ‚¬æµ®çƒ

// ç”µæ± ä¼˜åŒ–è±å…
BatteryOptimizationManager.requestIgnoreBatteryOptimizations(context)

// æ‰“å¼€å‚å•†è‡ªå¯åŠ¨è®¾ç½®
AutoStartPermissionManager.openAutoStartSettings(context)

// å‚å•†é›†æˆåˆ†æï¼ˆåˆ†æç›®æ ‡åº”ç”¨çš„ä¿æ´»æœºåˆ¶ï¼‰
VendorIntegrationAnalyzer.getFullAnalysisReport(context, "com.moji.mjweather")
```

---
![äºŒç»´ç ](https://github.com/Pangu-Immortal/Pangu-Immortal/blob/main/getqrcode.png)

ğŸ”¥ **Telegram ç¾¤ç»„**ï¼š [ç‚¹å‡»åŠ ç¾¤è®¨è®ºï¼Œè¿™é‡Œåªæ˜¯å†°å±±ä¸€è§’ã€‚](https://t.me/+V7HSo1YNzkFkY2M1)

## ä¿æ´»ç­–ç•¥å®Œæ•´åˆ—è¡¨

### 1. åŸºç¡€ç­–ç•¥

| ç­–ç•¥ | ç±»å | è¯´æ˜ | æœ‰æ•ˆæ€§ |
|-----|------|------|-------|
| å‰å°æœåŠ¡ | `FwForegroundService` | `foregroundServiceType="mediaPlayback"`ï¼Œç³»ç»Ÿè®¤ä¸ºæ˜¯åª’ä½“åº”ç”¨ | â­â­â­â­â­ |
| MediaSession | `MediaSessionManager` | åˆ›å»ºåª’ä½“ä¼šè¯ï¼Œè·å¾—ç³»ç»Ÿç‰¹æ®Šä¿æŠ¤ | â­â­â­â­â­ |
| 1 åƒç´  Activity | `OnePixelActivity` | å±å¹•å…³é—­æ—¶å¯åŠ¨é€æ˜ Activityï¼Œæå‡è¿›ç¨‹ä¼˜å…ˆçº§ | â­â­â­â­ |
| é”å± Activity | `LockScreenActivity` | åœ¨é”å±ç•Œé¢æ˜¾ç¤ºï¼ˆå¦‚é”å±å¤©æ°”ï¼‰ï¼Œä¿æŒå‰å°çŠ¶æ€ | â­â­â­â­â­ |
| æ‚¬æµ®çª— | `FloatWindowManager` | 1 åƒç´ æ‚¬æµ®çª—æˆ–æ‚¬æµ®çƒï¼Œç³»ç»Ÿè®¤ä¸ºåº”ç”¨åœ¨ä½¿ç”¨ä¸­ | â­â­â­â­ |

### 2. å®šæ—¶å”¤é†’ç­–ç•¥

| ç­–ç•¥ | ç±»å | è¯´æ˜ | æœ‰æ•ˆæ€§ |
|-----|------|------|-------|
| JobScheduler | `FwJobService` | ç³»ç»Ÿçº§ä»»åŠ¡è°ƒåº¦ï¼Œæœ€å°é—´éš” 15 åˆ†é’Ÿ | â­â­â­â­ |
| WorkManager | `FwWorker` | Jetpack ä»»åŠ¡è°ƒåº¦ï¼Œå…¼å®¹æ€§å¥½ | â­â­â­â­ |
| AlarmManager | `AlarmStrategy` | ç²¾ç¡®é—¹é’Ÿå”¤é†’ï¼Œéœ€è¦ `SCHEDULE_EXACT_ALARM` æƒé™ | â­â­â­ |

### 3. è´¦æˆ·åŒæ­¥ç­–ç•¥

| ç­–ç•¥ | ç±»å | è¯´æ˜ | æœ‰æ•ˆæ€§ |
|-----|------|------|-------|
| SyncAdapter | `FwSyncAdapter` | è´¦æˆ·åŒæ­¥æœºåˆ¶ï¼Œç³»ç»Ÿä¼šå®šæœŸè§¦å‘åŒæ­¥ | â­â­â­â­ |
| AccountAuthenticator | `FwAuthenticator` | è´¦æˆ·è®¤è¯æœåŠ¡ï¼Œé…åˆ SyncAdapter ä½¿ç”¨ | â­â­â­â­ |

### 4. å¹¿æ’­ç›‘å¬ç­–ç•¥ï¼ˆé™æ€æ³¨å†Œï¼‰

| ç­–ç•¥ | ç±»å | ç›‘å¬çš„å¹¿æ’­ | æœ‰æ•ˆæ€§ |
|-----|------|----------|-------|
| è“ç‰™å¹¿æ’­ | `BluetoothReceiver` | ACL_CONNECTED, A2DP, HEADSET, AUDIO_BECOMING_NOISY | â­â­â­â­â­ |
| USB å¹¿æ’­ | `UsbReceiver` | USB_DEVICE_ATTACHED, USB_ACCESSORY_ATTACHED | â­â­â­â­ |
| NFC å¹¿æ’­ | `NfcReceiver` | TAG_DISCOVERED, TECH_DISCOVERED, NDEF_DISCOVERED | â­â­â­â­ |
| åª’ä½“æŒ‰é”® | `MediaButtonReceiver` | MEDIA_BUTTONï¼ˆè“ç‰™è€³æœºæŒ‰é”®ï¼‰ | â­â­â­â­ |
| åª’ä½“æŒ‚è½½ | `MediaMountReceiver` | MEDIA_MOUNTED, MEDIA_EJECT, MEDIA_SCANNER | â­â­â­â­ |
| ç³»ç»Ÿäº‹ä»¶ | `SystemEventReceiver` | BOOT_COMPLETED, MY_PACKAGE_REPLACED | â­â­â­â­â­ |

### 5. å†…å®¹è§‚å¯Ÿè€…ç­–ç•¥

| ç­–ç•¥ | ç±»å | ç›‘å¬å†…å®¹ | æœ‰æ•ˆæ€§ |
|-----|------|---------|-------|
| ç›¸å†Œå˜åŒ– | `ContentObserverManager` | MediaStore.Images, Videos, Audio | â­â­â­ |
| è”ç³»äººå˜åŒ– | `ContentObserverManager` | ContactsContract | â­â­â­ |
| çŸ­ä¿¡å˜åŒ– | `ContentObserverManager` | Telephony.Sms | â­â­â­ |
| æ–‡ä»¶ç³»ç»Ÿ | `FileObserverManager` | Download, DCIM, Screenshots, Documents | â­â­â­ |

### 6. ç³»ç»Ÿçº§æœåŠ¡ç­–ç•¥

| ç­–ç•¥ | ç±»å | è¯´æ˜ | æœ‰æ•ˆæ€§ |
|-----|------|------|-------|
| æ— éšœç¢æœåŠ¡ | `FwAccessibilityService` | ç³»ç»Ÿçº§æœåŠ¡ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œéœ€ç”¨æˆ·æ‰‹åŠ¨å¼€å¯ | â­â­â­â­â­ |
| é€šçŸ¥ç›‘å¬æœåŠ¡ | `FwNotificationListenerService` | ç³»ç»Ÿçº§æœåŠ¡ï¼Œè¢«æ€åç³»ç»Ÿè‡ªåŠ¨é‡å¯ | â­â­â­â­â­ |

### 7. åŒè¿›ç¨‹å®ˆæŠ¤ç­–ç•¥

| ç­–ç•¥ | ç±»å | è¯´æ˜ | æœ‰æ•ˆæ€§ |
|-----|------|------|-------|
| Java åŒè¿›ç¨‹ | `DaemonService` | ç‹¬ç«‹è¿›ç¨‹ `:daemon`ï¼Œäº’ç›¸å®ˆæŠ¤ | â­â­â­â­ |
| Native å®ˆæŠ¤è¿›ç¨‹ | `FwNative` | C++ fork() å­è¿›ç¨‹ç›‘æ§ï¼Œä½¿ç”¨ am å‘½ä»¤é‡å¯ | â­â­â­â­ |
| Socket å¿ƒè·³ | `FwNative` | Unix Domain Socket è¿›ç¨‹é—´é€šä¿¡ | â­â­â­ |

### 8. MediaRoute ä¿æ´»ç­–ç•¥ï¼ˆæ–°å¢ v2.2.0ï¼‰

è¿™æ˜¯**é…·ç‹—éŸ³ä¹**ç­‰åº”ç”¨çš„æ ¸å¿ƒä¿æ´»æŠ€æœ¯ä¹‹ä¸€ã€‚é€šè¿‡å‘ç³»ç»Ÿæ³¨å†Œè™šæ‹Ÿåª’ä½“è·¯ç”±ï¼Œè·å¾—"åª’ä½“ç±»åº”ç”¨"èº«ä»½ï¼Œç³»ç»Ÿä¼šç»´æŠ¤æœåŠ¡è¿æ¥ï¼Œä¸å®¹æ˜“è¢«æ€æ­»ã€‚

| ç­–ç•¥ | ç±»å | è¯´æ˜ | æœ‰æ•ˆæ€§ |
|-----|------|------|-------|
| MediaRouteProviderService | `FwMediaRouteProviderService` | å‘ MediaRouter æ³¨å†Œåª’ä½“è·¯ç”±æä¾›è€…ï¼Œç³»ç»Ÿç»´æŠ¤ Binder è¿æ¥ | â­â­â­â­â­ |
| MediaRoute2ProviderService | `FwMediaRoute2ProviderService` | Android 11+ æ–° MediaRouter2 APIï¼ŒåŒé‡ä¿æ´» | â­â­â­â­â­ |
| MediaRoute Native | `FwMediaRouteNative` | C++ å±‚æœåŠ¡çŠ¶æ€ç›‘æ§ã€å¿ƒè·³æ£€æµ‹ã€WakeLock ç®¡ç† | â­â­â­â­ |
| MediaRoute Manager | `FwMediaRouteManager` | ç»Ÿä¸€ç®¡ç†æ¨¡å—ç”Ÿå‘½å‘¨æœŸï¼Œæ ¹æ®ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©æ€§å¯åŠ¨ | â­â­â­â­ |

**æ ¸å¿ƒæœºåˆ¶ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç³»ç»Ÿ MediaRouter æœåŠ¡                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ MediaRouter (æ—§ç‰ˆ) â”‚     â”‚ MediaRouter2 (Android 11+) â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Binder è¿æ¥                 â”‚ Binder è¿æ¥
             â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FwMediaRouteProvider   â”‚    â”‚ FwMediaRoute2ProviderService â”‚
â”‚ Service                â”‚    â”‚                             â”‚
â”‚  - æ³¨å†Œè™šæ‹Ÿåª’ä½“è·¯ç”±      â”‚    â”‚  - å‘å¸ƒ MediaRoute2 è·¯ç”±     â”‚
â”‚  - 30ç§’å¿ƒè·³æ£€æŸ¥         â”‚    â”‚  - 30ç§’å¿ƒè·³æ£€æŸ¥              â”‚
â”‚  - WakeLock ç®¡ç†        â”‚    â”‚  - è§¦å‘ä¿æ´»æ£€æŸ¥              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   FwMediaRouteNative    â”‚
               â”‚   (C++ Native å±‚)        â”‚
               â”‚  - æœåŠ¡çŠ¶æ€ç›‘æ§          â”‚
               â”‚  - å¿ƒè·³è®¡æ•°              â”‚
               â”‚  - WakeLock æ£€æŸ¥         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®ç¤ºä¾‹ï¼š**

```kotlin
Fw.init(this) {
    // MediaRoute ä¿æ´»ç­–ç•¥ï¼ˆé»˜è®¤å¼€å¯ï¼‰
    enableMediaRouteProvider = true      // MediaRouteProviderService
    enableMediaRoute2Provider = true     // MediaRoute2ProviderService (Android 11+)
    enableMediaIntentActivity = true     // åª’ä½“æ„å›¾å¤„ç† Activity
}
```

**ç›¸å…³æ–‡ä»¶ï¼š**

```
framework/src/main/java/com/service/framework/mediaroute/
â”œâ”€â”€ FwMediaRouteManager.kt           # æ¨¡å—ç®¡ç†å™¨
â”œâ”€â”€ FwMediaRouteProviderService.kt   # MediaRoute æœåŠ¡
â”œâ”€â”€ FwMediaRoute2ProviderService.kt  # MediaRoute2 æœåŠ¡ (Android 11+)
â”œâ”€â”€ FwMediaRouteProvider.kt          # è‡ªå®šä¹‰è·¯ç”±æä¾›è€…
â”œâ”€â”€ FwMediaRouteNative.kt            # Native å±‚ JNI æ¥å£
â””â”€â”€ FwMediaActivity.kt               # åª’ä½“æ„å›¾å¤„ç† Activity

framework/src/main/cpp/mediaroute/
â”œâ”€â”€ CMakeLists.txt                   # CMake æ„å»ºé…ç½®
â””â”€â”€ fw_mediaroute_jni.cpp            # Native å±‚å®ç°
```

### 9. æ— æ³•å¼ºåˆ¶åœæ­¢ç­–ç•¥
åŸç†ä»‹ç»ï¼Œé˜…è¯»åœ°å€ï¼šhttps://mp.weixin.qq.com/s/-9L6XOfrzh69hOQ9puK6iQ

| ç­–ç•¥ | ç±»å | è¯´æ˜ | æœ‰æ•ˆæ€§ |
|-----|------|------|-------|
| å¤šè¿›ç¨‹æ–‡ä»¶é”ç›‘æ§ | `ForceStopResistance` | å¤šä¸ªè¾…åŠ©è¿›ç¨‹é€šè¿‡æ–‡ä»¶é”äº’ç›¸ç›‘æ§ | â­â­â­â­ |
| app_process æ‹‰æ´» | `AppProcessLauncher` | é€šè¿‡ app_process å‘½ä»¤å¯åŠ¨ Java è¿›ç¨‹ | â­â­â­â­ |
| AMS Binder ç›´æ¥è°ƒç”¨ | `AmsBinderInvoker` | ç›´æ¥è°ƒç”¨ AMS Binder å¯åŠ¨æœåŠ¡/å¹¿æ’­/Instrumentation | â­â­â­â­â­ |
| Instrumentation æ‹‰æ´» | `FwInstrumentation` | é€šè¿‡ am instrument å‘½ä»¤æ‹‰èµ·è¿›ç¨‹ | â­â­â­â­ |

> **é€‚ç”¨èŒƒå›´**ï¼šæ­¤ç­–ç•¥åœ¨ **Android 5.0 - 12.0** (API 21 - 31) ä¸Šæµ‹è¯•æœ‰æ•ˆã€‚Android 10+ å®˜æ–¹å£°ç§°å·²å°å µï¼Œå®é™…åœ¨ Android 13 æ‰å¼€å§‹ä¸‹å‘çš„è¡¥ä¸ï¼Œå®æµ‹å¤§éƒ¨åˆ†çš„è®¾å¤‡ä»å¯ç”¨ã€‚
>
> **é»˜è®¤å…³é—­**ï¼šç”±äºä¾µå…¥æ€§è¾ƒå¼ºï¼Œæ­¤åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œéœ€æ‰‹åŠ¨å¯ç”¨ã€‚
>
> **æ•™å­¦æ„ä¹‰**ï¼šæ­¤åŠŸèƒ½å¤ç°äº†æ—©æœŸ Android ç”Ÿæ€çš„å®‰å…¨æ¼æ´ï¼Œå±•ç¤ºç³»ç»Ÿæ¼”è¿›è¿‡ç¨‹ä¸­çš„æ”»é˜²åšå¼ˆã€‚

#### æ ¸å¿ƒåŸç†ï¼š5ms æ—¶é—´å·®ç«äº‰

æ— æ³•å¼ºåˆ¶åœæ­¢çš„å…³é”®åœ¨äº **æ€æ­»ä¸å”¤é†’çš„æ—¶é—´å·®**ã€‚å½“ç”¨æˆ·ç‚¹å‡»ã€Œå¼ºåˆ¶åœæ­¢ã€æ—¶ï¼Œç³»ç»Ÿéœ€è¦é€ä¸ªæ€æ­»åº”ç”¨çš„æ‰€æœ‰è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹ä¹‹é—´å­˜åœ¨çº¦ **5ms** çš„æ—¶é—´é—´éš”ã€‚

**ä¸ºä»€ä¹ˆå­˜åœ¨æ—¶é—´å·®ï¼Ÿ**

Android ç³»ç»Ÿå¼ºåˆ¶åœæ­¢åº”ç”¨æ—¶çš„æ‰§è¡Œæµç¨‹ï¼š

1. AMS éå†åº”ç”¨çš„æ‰€æœ‰è¿›ç¨‹
2. å¯¹æ¯ä¸ªè¿›ç¨‹è°ƒç”¨ `Process.killProcess()` æˆ–å‘é€ `SIGKILL`
3. ç­‰å¾…è¿›ç¨‹æ­»äº¡ç¡®è®¤
4. ç»§ç»­æ€æ­»ä¸‹ä¸€ä¸ªè¿›ç¨‹

è¿™ä¸ªã€Œéå† â†’ æ€æ­» â†’ ç¡®è®¤ã€çš„å¾ªç¯éœ€è¦æ—¶é—´ï¼Œæ¯ä¸ªè¿›ç¨‹å¤§çº¦ **5ms**ã€‚å¦‚æœåº”ç”¨æœ‰ 4 ä¸ªè¿›ç¨‹ï¼ˆä¸»è¿›ç¨‹ + 3 ä¸ªè¾…åŠ©è¿›ç¨‹ï¼‰ï¼Œæ€»æ—¶é—´çª—å£çº¦ **15-20ms**ã€‚

**ä¸ºä»€ä¹ˆ 5ms è¶³å¤Ÿï¼Ÿ**

å…³é”®åœ¨äºä½¿ç”¨ **C++ Native å±‚ç›´æ¥ Binder è°ƒç”¨**ï¼Œè€Œä¸æ˜¯ Java å±‚ï¼š

| æ–¹å¼ | è°ƒç”¨é“¾ | è€—æ—¶ |
|-----|-------|-----|
| Java `startService()` | Intent åˆ›å»º â†’ Parcel åºåˆ—åŒ– â†’ Binder ä»£ç† â†’ AMS å¤„ç† | **10-50ms** |
| C++ ç›´æ¥ Binder | `open("/dev/binder")` â†’ é¢„æ„é€  Parcel â†’ `ioctl()` å‘é€ | **< 1ms** |

C++ å±‚çš„ä¼˜åŠ¿ï¼š

- **é¢„å…ˆæ„é€  Parcel**ï¼šæœåŠ¡å¯åŠ¨å‚æ•°åœ¨åˆå§‹åŒ–æ—¶å°±åºåˆ—åŒ–å¥½ï¼Œæ£€æµ‹åˆ°æ­»äº¡æ—¶ç›´æ¥å‘é€
- **è·³è¿‡ Intent è§£æ**ï¼šä¸éœ€è¦åˆ›å»º Intent å¯¹è±¡ï¼Œçœå»å¯¹è±¡åˆ›å»ºå¼€é”€
- **ç›´æ¥é©±åŠ¨è°ƒç”¨**ï¼šé€šè¿‡ `ioctl(fd, BINDER_WRITE_READ, &bwr)` ç›´æ¥ä¸ Binder é©±åŠ¨é€šä¿¡
- **æ—  GC å¼€é”€**ï¼šçº¯ C++ ä»£ç ï¼Œä¸å— Java åƒåœ¾å›æ”¶å½±å“

**æ—¶é—´çº¿ç¤ºä¾‹**ï¼š

```
T=0ms    : ç”¨æˆ·ç‚¹å‡»ã€Œå¼ºåˆ¶åœæ­¢ã€
T=1ms    : ç³»ç»Ÿå¼€å§‹æ€æ­»è¿›ç¨‹1ï¼ˆä¸»è¿›ç¨‹ï¼‰
T=2ms    : è¿›ç¨‹1 æ–‡ä»¶é”é‡Šæ”¾ï¼Œè¿›ç¨‹2 æ£€æµ‹åˆ°
T=2.5ms  : è¿›ç¨‹2 é€šè¿‡ Binder ç›´æ¥è°ƒç”¨ AMS.startService â† å…³é”®ï¼
T=3ms    : AMS æ”¶åˆ°è¯·æ±‚ï¼Œå¼€å§‹å¯åŠ¨æœåŠ¡
T=6ms    : ç³»ç»Ÿæ€æ­»è¿›ç¨‹2
T=8ms    : æ–°æœåŠ¡è¿›ç¨‹å¯åŠ¨å®Œæˆ â† æ‹‰æ´»æˆåŠŸï¼
T=11ms   : ç³»ç»Ÿæ€æ­»è¿›ç¨‹3
T=16ms   : ç³»ç»Ÿæ€æ­»è¿›ç¨‹4
T=20ms   : å¼ºåˆ¶åœæ­¢æµç¨‹ç»“æŸï¼Œä½†æœåŠ¡å·²é‡æ–°è¿è¡Œ
```

**AMS Binder ç›´æ¥è°ƒç”¨æ˜¯æ ¸å¿ƒ**ï¼š
- ä¼ ç»Ÿæ–¹å¼ï¼š`startService()` â†’ åˆ›å»º Intent â†’ Binder ä»£ç† â†’ AMS â†’ å¯åŠ¨æœåŠ¡ï¼ˆè€—æ—¶é•¿ï¼‰
- ç›´æ¥è°ƒç”¨ï¼šæ‰“å¼€ /dev/binder â†’ é¢„æ„é€  Parcel â†’ `ioctl()` ç›´æ¥å‘é€ï¼ˆè€—æ—¶æçŸ­ï¼‰

é€šè¿‡è·³è¿‡ Intent è§£æã€æƒé™æ£€æŸ¥ç­‰ä¸­é—´æ­¥éª¤ï¼Œç›´æ¥å‘ AMS å‘é€å¯åŠ¨è¯·æ±‚ï¼Œå¯ä»¥åœ¨è¿›ç¨‹è¢«å®Œå…¨æ€æ­»å‰å®Œæˆæ‹‰æ´»æ“ä½œã€‚

#### å·¥ä½œæµç¨‹

**é˜¶æ®µä¸€ï¼šåˆå§‹åŒ–ï¼ˆåº”ç”¨å¯åŠ¨æ—¶ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           åº”ç”¨å¯åŠ¨                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼               â–¼               â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  ä¸»è¿›ç¨‹      â”‚ â”‚ è¾…åŠ©è¿›ç¨‹1    â”‚ â”‚ è¾…åŠ©è¿›ç¨‹2    â”‚
            â”‚  :main      â”‚ â”‚ :assist1    â”‚ â”‚ :assist2    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚               â”‚
                    â–¼               â–¼               â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ 1.é”å®šæ–‡ä»¶A  â”‚ â”‚ 1.é”å®šæ–‡ä»¶B  â”‚ â”‚ 1.é”å®šæ–‡ä»¶C  â”‚
            â”‚ 2.æ‰“å¼€Binder â”‚ â”‚ 2.æ‰“å¼€Binder â”‚ â”‚ 2.æ‰“å¼€Binder â”‚
            â”‚ 3.è·å–AMSå¥æŸ„â”‚ â”‚ 3.è·å–AMSå¥æŸ„â”‚ â”‚ 3.è·å–AMSå¥æŸ„â”‚
            â”‚ 4.é¢„æ„é€ Parcelâ”‚ â”‚ 4.é¢„æ„é€ Parcelâ”‚ â”‚ 4.é¢„æ„é€ Parcelâ”‚
            â”‚ 5.forkå®ˆæŠ¤è¿›ç¨‹â”‚ â”‚ 5.forkå®ˆæŠ¤è¿›ç¨‹â”‚ â”‚ 5.forkå®ˆæŠ¤è¿›ç¨‹â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ‰€æœ‰è¿›ç¨‹äº’ç›¸ç›‘æ§å¯¹æ–¹çš„æ–‡ä»¶é”  â”‚
                    â”‚  ï¼ˆé˜»å¡åœ¨ flock() ç­‰å¾…é”é‡Šæ”¾ï¼‰ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é˜¶æ®µäºŒï¼šå¼ºåˆ¶åœæ­¢è§¦å‘æ—¶çš„æ—¶é—´ç«äº‰**

```
æ—¶é—´è½´ï¼ˆæ¯«ç§’ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T=0ms   â”‚ ç”¨æˆ·ç‚¹å‡»ã€Œå¼ºåˆ¶åœæ­¢ã€
        â”‚
T=1ms   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ AMS å¼€å§‹æ€æ­»ä¸»è¿›ç¨‹ (:main)                                   â”‚
        â”‚ â”‚ â†’ Process.killProcess() / SIGKILL                           â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
T=2ms   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ ä¸»è¿›ç¨‹æ­»äº¡ â†’ æ–‡ä»¶é”Aè‡ªåŠ¨é‡Šæ”¾                                  â”‚
        â”‚ â”‚ â†’ è¾…åŠ©è¿›ç¨‹1 çš„ flock() ç«‹å³è¿”å›ï¼ˆæ£€æµ‹åˆ°ä¸»è¿›ç¨‹æ­»äº¡ï¼ï¼‰          â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
T=2.5ms â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ ã€å…³é”®ã€‘è¾…åŠ©è¿›ç¨‹1 é€šè¿‡é¢„æ„é€ çš„ Parcel ç›´æ¥ ioctl() è°ƒç”¨      â”‚
        â”‚ â”‚ â†’ Binder transact åˆ° AMS.startService()                     â”‚
        â”‚ â”‚ â†’ è€—æ—¶ < 1msï¼ˆå› ä¸º Parcel å·²é¢„æ„é€ ï¼Œæ— éœ€åˆ›å»ºå¯¹è±¡ï¼‰            â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
T=3ms   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ AMS æ”¶åˆ° startService è¯·æ±‚                                   â”‚
        â”‚ â”‚ â†’ å¼€å§‹åˆ›å»ºæ–°çš„æœåŠ¡è¿›ç¨‹                                       â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
T=6ms   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ AMS ç»§ç»­æ€æ­»è¾…åŠ©è¿›ç¨‹1 (:assist1)                             â”‚
        â”‚ â”‚ â†’ ä½† startService è¯·æ±‚å·²å‘å‡ºï¼                               â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
T=8ms   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ ã€æ‹‰æ´»æˆåŠŸã€‘æ–°æœåŠ¡è¿›ç¨‹å¯åŠ¨å®Œæˆ                                â”‚
        â”‚ â”‚ â†’ åº”ç”¨å·²é‡æ–°è¿è¡Œï¼                                           â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
T=11ms  â”‚ AMS æ€æ­»è¾…åŠ©è¿›ç¨‹2 (:assist2)
        â”‚
T=16ms  â”‚ AMS æ€æ­»è¾…åŠ©è¿›ç¨‹3 (:assist3)
        â”‚
T=20ms  â”‚ å¼ºåˆ¶åœæ­¢æµç¨‹ç»“æŸ
        â”‚ â†’ ä½†åº”ç”¨æœåŠ¡å·²åœ¨ T=8ms é‡æ–°è¿è¡Œï¼
        â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**å…³é”®ç‚¹æ€»ç»“**ï¼š

| æ­¥éª¤ | æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|-----|------|-----|------|
| 1 | æ£€æµ‹è¿›ç¨‹æ­»äº¡ | ~0ms | flock() é˜»å¡ç­‰å¾…ï¼Œé”é‡Šæ”¾ç«‹å³è¿”å› |
| 2 | å‘é€ Binder è¯·æ±‚ | <1ms | é¢„æ„é€  Parcel + ç›´æ¥ ioctl() |
| 3 | AMS å¤„ç†è¯·æ±‚ | ~5ms | ç³»ç»Ÿåˆ›å»ºæ–°è¿›ç¨‹ |
| **æ€»è®¡** | **ä»æ£€æµ‹åˆ°æ‹‰æ´»** | **<6ms** | **å°äºè¿›ç¨‹æ€æ­»é—´éš”ï¼ˆ~5msï¼‰** |

#### ä¸ºä»€ä¹ˆ Android 10+ ç†è®ºä¸Šå¤±æ•ˆï¼Ÿ

Android 10 å¼€å§‹å¼•å…¥äº†ä»¥ä¸‹é™åˆ¶ï¼š

1. **cgroup è¿›ç¨‹ç»„æ€æ­»**ï¼šå¼ºåˆ¶åœæ­¢æ—¶ä½¿ç”¨ `killProcessGroup()` æ€æ­»æ•´ä¸ª cgroupï¼Œç†è®ºä¸Šæ‰€æœ‰è¿›ç¨‹åŒæ—¶æ­»äº¡
2. **åå°å¯åŠ¨é™åˆ¶**ï¼šåå°è¿›ç¨‹æ— æ³•å¯åŠ¨ Activity/Service
3. **Binder è°ƒç”¨é™åˆ¶**ï¼šéå‰å°è¿›ç¨‹çš„ Binder è°ƒç”¨å—é™
4. **SELinux åŠ å¼º**ï¼šapp_process ç­‰å‘½ä»¤æ‰§è¡Œå—é™

**ä½†å®æµ‹æƒ…å†µ**ï¼šåœ¨éƒ¨åˆ† Android 12 è®¾å¤‡ä¸Šï¼Œæ­¤ç­–ç•¥ä»ç„¶æœ‰æ•ˆã€‚å¯èƒ½åŸå› ï¼š

- æŸäº›å‚å•† ROM æœªå®Œå…¨å®ç° cgroup è¿›ç¨‹ç»„æ€æ­»
- `killProcessGroup()` å®é™…æ‰§è¡Œä»å­˜åœ¨å¾®å°æ—¶é—´å·®
- è®¾å¤‡å†…æ ¸ç‰ˆæœ¬å·®å¼‚å¯¼è‡´è¡Œä¸ºä¸ä¸€è‡´

å»ºè®®åœ¨ç›®æ ‡è®¾å¤‡ä¸Šå®é™…æµ‹è¯•éªŒè¯æ•ˆæœã€‚

#### Native å±‚å®ç°ï¼ˆC++ï¼‰

ä¸ºäº†æœ€å¤§åŒ–æ—¶é—´çª—å£åˆ©ç”¨ç‡ï¼Œæ ¸å¿ƒé€»è¾‘ä½¿ç”¨ C++ å®ç°ï¼š

```
framework/src/main/cpp/
â”œâ”€â”€ fw_force_stop.cpp          # æ— æ³•å¼ºåˆ¶åœæ­¢æ ¸å¿ƒå®ç°
â”œâ”€â”€ binder/
â”‚   â”œâ”€â”€ common.h               # å…¬å…±å®šä¹‰
â”‚   â”œâ”€â”€ cParcel.cpp/h          # Parcel æ•°æ®å°è£…
â”‚   â””â”€â”€ data_transact.cpp/h    # Binder äº‹åŠ¡å¤„ç†
â””â”€â”€ utils/
    â”œâ”€â”€ String16.cpp/h         # UTF-16 å­—ç¬¦ä¸²
    â”œâ”€â”€ Unicode.cpp/h          # Unicode ç¼–è§£ç 
    â””â”€â”€ SharedBuffer.cpp/h     # å…±äº«ç¼“å†²åŒº
```

å…³é”®æŠ€æœ¯ç‚¹ï¼š

1. **ç›´æ¥æ‰“å¼€ /dev/binder** - é€šè¿‡ `open("/dev/binder")` ç›´æ¥è®¿é—® Binder é©±åŠ¨
2. **æ‰‹åŠ¨æ„é€  Parcel** - ä¸ä¾èµ– Android Frameworkï¼Œæ‰‹åŠ¨åºåˆ—åŒ–æ•°æ®
3. **ioctl ç³»ç»Ÿè°ƒç”¨** - ä½¿ç”¨ `ioctl(fd, BINDER_WRITE_READ, &bwr)` ç›´æ¥é€šä¿¡
4. **flock æ–‡ä»¶é”** - ä½¿ç”¨ POSIX æ–‡ä»¶é”æ£€æµ‹è¿›ç¨‹æ­»äº¡

### 10. è¿›ç¨‹ä¼˜å…ˆçº§ç®¡ç†

| åŠŸèƒ½ | ç±»å | è¯´æ˜ |
|-----|------|------|
| è¿›ç¨‹çŠ¶æ€ç›‘æ§ | `ProcessPriorityManager` | è·å–å½“å‰è¿›ç¨‹ importanceã€OOM adj å€¼ |
| è¢«æ€é£é™©è¯„ä¼° | `ProcessPriorityManager` | è¯„ä¼°è¿›ç¨‹è¢«ç³»ç»Ÿæ€æ­»çš„é£é™©ç­‰çº§ |
| å†…å­˜ä¿¡æ¯è·å– | `ProcessPriorityManager` | è·å–ç³»ç»Ÿå’Œåº”ç”¨å†…å­˜ä½¿ç”¨æƒ…å†µ |

### 11. å‚å•†é›†æˆç­–ç•¥

| åŠŸèƒ½ | ç±»å | è¯´æ˜ |
|-----|------|------|
| ç”µæ± ä¼˜åŒ–è±å… | `BatteryOptimizationManager` | è¯·æ±‚åŠ å…¥ Doze ç™½åå• |
| å‚å•†è‡ªå¯åŠ¨ç®¡ç† | `AutoStartPermissionManager` | æ‰“å¼€å„å‚å•†çš„è‡ªå¯åŠ¨è®¾ç½®é¡µé¢ |
| å‚å•†é›†æˆåˆ†æ | `VendorIntegrationAnalyzer` | åˆ†æåº”ç”¨çš„æ¨é€ SDK å’Œç³»ç»Ÿæƒé™ |

---

## å‚å•†æ¨é€é€šé“å¤ç”¨ï¼ˆé«˜çº§ç­–ç•¥ï¼‰

å¢¨è¿¹å¤©æ°”ç­‰åº”ç”¨"æ°¸ç”Ÿä¸æ­»"çš„æ ¸å¿ƒç§˜å¯†ä¹‹ä¸€ï¼š**å‚å•†æ¨é€é€šé“**ã€‚

### åŸç†

å‚å•†æ¨é€æœåŠ¡ï¼ˆå°ç±³æ¨é€ã€åä¸ºæ¨é€ã€FCM ç­‰ï¼‰æ˜¯ç³»ç»Ÿçº§å¸¸é©»æœåŠ¡ï¼Œå³ä½¿åº”ç”¨è¢«æ€ï¼Œæ¨é€åˆ°è¾¾æ—¶ä¹Ÿä¼šæ‹‰èµ·åº”ç”¨ã€‚

### é›†æˆæ–¹å¼ï¼ˆä¸¾ä¾‹å­ï¼‰

```kotlin
// 1. é›†æˆå‚å•†æ¨é€ SDK
// å°ç±³æ¨é€
implementation("com.xiaomi.mipush:sdk:5.1.2")

// åä¸ºæ¨é€
implementation("com.huawei.hms:push:6.11.0.300")

// OPPO æ¨é€
implementation("com.heytap.msp:push:3.1.0")

// vivo æ¨é€
implementation("com.vivo.push:vivo-push:3.0.0.6")

// Google FCM
implementation("com.google.firebase:firebase-messaging-ktx:23.4.0")

// 2. åœ¨åº”ç”¨ä¸­æ³¨å†Œæ¨é€
class MyApp : Application() {
    override fun onCreate() {
        super.onCreate()

        // åˆå§‹åŒ–ä¿æ´»æ¡†æ¶
        Fw.init(this)

        // åˆå§‹åŒ–å‚å•†æ¨é€ï¼ˆæ ¹æ®è®¾å¤‡è‡ªåŠ¨é€‰æ‹©ï¼‰
        when {
            isMiui() -> MiPushClient.registerPush(this, APP_ID, APP_KEY)
            isEmui() -> HmsMessaging.getInstance(this).isAutoInitEnabled = true
            isColorOS() -> HeytapPushManager.init(this, true)
            isFuntouchOS() -> PushClient.getInstance(this).initialize()
            else -> {
                // å¯¹äºåŸç”Ÿã€Googleã€ä¼ éŸ³ç­‰å…¶ä»–è®¾å¤‡ï¼Œç»Ÿä¸€ä½¿ç”¨ FCM
                Firebase.messaging.isAutoInitEnabled = true
            }
        }
    }
}
```

### æ¨é€ SDK åŒ…åå‚è€ƒ

| å‚å•† | æ¨é€ SDK | åŒ…å |
|-----|---------|------|
| å°ç±³ | MiPush | `com.xiaomi.mipush.sdk` |
| åä¸º | HMS Push | `com.huawei.hms.push` |
| OPPO | OPPO Push | `com.heytap.msp` |
| vivo | vivo Push | `com.vivo.push` |
| Google | FCM | `com.google.firebase.messaging` |
| é­…æ— | Flyme Push | `com.meizu.cloud.pushsdk` |
| ä¸ªæ¨ | GeTui | `com.igexin.sdk` |
| æå…‰ | JPush | `cn.jpush.android` |

### FCM æ•°æ®æ¶ˆæ¯ (Data Message) æ¨¡å¼å»ºè®®ï¼ˆåªæœ‰ data æ¨¡å¼å¯ä»¥æ‹‰æ´»ï¼‰

å¯¹äºé€šè¿‡ FCM (Firebase Cloud Messaging) è¿›è¡Œæ¨é€ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ **æ•°æ®æ¶ˆæ¯ (Data Message)** è€Œä¸æ˜¯é€šçŸ¥æ¶ˆæ¯ (Notification Message)ã€‚

| ç±»å‹ | `notification` æ¶ˆæ¯ | `data` æ¶ˆæ¯ |
|---|---|---|
| **ä¼˜ç‚¹** | ç®€å•ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨å¤„ç†é€šçŸ¥æ˜¾ç¤ºã€‚ | çµæ´»æ€§é«˜ï¼Œåº”ç”¨å®Œå…¨æ§åˆ¶æ¶ˆæ¯å¤„ç†å’Œé€šçŸ¥æ˜¾ç¤ºã€‚ |
| **ç¼ºç‚¹** | åº”ç”¨åœ¨åå°æ—¶ï¼Œæ¶ˆæ¯ç”±ç³»ç»Ÿå¤„ç†ï¼Œæ— æ³•è‡ªå®šä¹‰ï¼Œ**å¯èƒ½ä¸ä¼šå”¤é†’åº”ç”¨**ã€‚ | éœ€è¦åº”ç”¨è‡ªå·±å®ç° `FirebaseMessagingService` æ¥æ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯ã€‚ |
| **å”¤é†’èƒ½åŠ›** | å¼±ï¼ˆåå°æ—¶ç”±ç³»ç»Ÿå†³å®šï¼‰ | **å¼ºï¼ˆåº”ç”¨åœ¨åå°æˆ–è¢«æ€æ—¶ï¼Œå¯ä»¥é«˜ä¼˜å…ˆçº§å”¤é†’åº”ç”¨å¹¶æ‰§è¡Œä»£ç ï¼‰** |

**ä¸ºä»€ä¹ˆä½¿ç”¨ `data` æ¶ˆæ¯ï¼Ÿ**

ä¸ºäº†ç¡®ä¿åå°å”¤é†’çš„å¯é æ€§ï¼Œ`data` æ¶ˆæ¯æ˜¯å¿…é¡»çš„ã€‚å½“åº”ç”¨æ”¶åˆ° `data` æ¶ˆæ¯æ—¶ï¼Œ`onMessageReceived` å›è°ƒä¼šè¢«è§¦å‘ï¼Œå³ä½¿åº”ç”¨åœ¨åå°ã€‚è¿™ç»™äº†æˆ‘ä»¬æ‰§è¡Œä»£ç ã€å¯åŠ¨æœåŠ¡ã€å¼¹å‡ºè‡ªå®šä¹‰é€šçŸ¥çš„æœºä¼šï¼Œä»è€Œå®ç°å¯é çš„ä¿æ´»ã€‚

**å®ç°ç¤ºä¾‹:**

1.  **åœ¨ `AndroidManifest.xml` ä¸­æ³¨å†ŒæœåŠ¡:**
    ```xml
    <service
        android:name=".MyFirebaseMessagingService"
        android:exported="false">
        <intent-filter>
            <action android:name="com.google.firebase.MESSAGING_EVENT" />
        </intent-filter>
    </service>
    ```

2.  **å®ç° `FirebaseMessagingService`:**
    ```kotlin
    class MyFirebaseMessagingService : FirebaseMessagingService() {
        override fun onMessageReceived(remoteMessage: RemoteMessage) {
            // æ”¶åˆ°æ•°æ®æ¶ˆæ¯
            FwLog.d("FCM", "From: ${remoteMessage.from}")

            // æ£€æŸ¥æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å« data payload
            remoteMessage.data.isNotEmpty().let {
                FwLog.d("FCM", "Message data payload: " + remoteMessage.data)

                // åœ¨è¿™é‡Œæ‰§è¡Œå”¤é†’é€»è¾‘
                // ä¾‹å¦‚ï¼šå¯åŠ¨ä¸€ä¸ªå‰å°æœåŠ¡
                Fw.check()
            }
        }
    }
    ```

3.  **æœåŠ¡ç«¯å‘é€ `data` æ¶ˆæ¯ (JSON æ ¼å¼):**
    ```json
    {
      "to": "DEVICE_TOKEN",
      "priority": "high",
      "data": {
        "title": "åå°ä»»åŠ¡",
        "body": "æ­£åœ¨æ‰§è¡Œåå°ä»»åŠ¡...",
        "action": "KEEP_ALIVE_CHECK"
      }
    }
    ```
    **å…³é”®ç‚¹:**
    - `priority` è®¾ç½®ä¸º `high`ï¼Œä»¥è·å¾—æœ€åŠæ—¶çš„ä¼ é€’ï¼ˆå³ä½¿åœ¨ Doze æ¨¡å¼ä¸‹ï¼‰ã€‚
    - æ¶ˆæ¯ä½“ä¸­åªåŒ…å« `data` å­—æ®µï¼Œä¸åŒ…å« `notification` å­—æ®µã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒFCM å°±ä¸å†ä»…ä»…æ˜¯ä¸€ä¸ªé€šçŸ¥é€šé“ï¼Œè€Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„åå°å”¤é†’å·¥å…·ã€‚

---

### æ£€æµ‹å‘½ä»¤

```bash
# æ£€æŸ¥ç³»ç»Ÿç™½åå•
adb shell cat /system/etc/sysconfig/*.xml | grep -i moji

# æ£€æŸ¥åº”ç”¨ç­¾å
adb shell dumpsys package com.moji.mjweather | grep -A5 "signatures"

# æ£€æŸ¥æ˜¯å¦é¢„è£…
adb shell pm path com.moji.mjweather

# æ£€æŸ¥åº”ç”¨æƒé™
adb shell dumpsys package com.moji.mjweather | grep permission
```

---

## é¡¹ç›®æ¶æ„

```
KeepLiveService/
â”œâ”€â”€ app/                           # ç¤ºä¾‹åº”ç”¨æ¨¡å—
â”‚   â””â”€â”€ src/main/
â”‚       â”œâ”€â”€ java/.../
â”‚       â”‚   â”œâ”€â”€ KeepLiveApp.kt     # Application å…¥å£
â”‚       â”‚   â””â”€â”€ MainActivity.kt    # ä¸»ç•Œé¢
â”‚       â””â”€â”€ AndroidManifest.xml
â”‚
â”œâ”€â”€ framework/                     # ä¿æ´»æ¡†æ¶æ¨¡å—
â”‚   â””â”€â”€ src/main/
â”‚       â”œâ”€â”€ java/com/service/framework/
â”‚       â”‚   â”œâ”€â”€ Fw.kt                        # æ¡†æ¶å…¥å£ï¼ˆä¸€è¡Œä»£ç åˆå§‹åŒ–ï¼‰
â”‚       â”‚   â”œâ”€â”€ core/
â”‚       â”‚   â”‚   â””â”€â”€ FwConfig.kt              # é…ç½®ç±»ï¼ˆBuilder æ¨¡å¼ï¼‰
â”‚       â”‚   â”œâ”€â”€ service/
â”‚       â”‚   â”‚   â”œâ”€â”€ FwForegroundService.kt   # ä¸»å‰å°æœåŠ¡
â”‚       â”‚   â”‚   â””â”€â”€ DaemonService.kt         # å®ˆæŠ¤è¿›ç¨‹æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ receiver/
â”‚       â”‚   â”‚   â”œâ”€â”€ BluetoothReceiver.kt     # è“ç‰™å¹¿æ’­ï¼ˆæ ¸å¿ƒï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ UsbReceiver.kt           # USB è®¾å¤‡å¹¿æ’­
â”‚       â”‚   â”‚   â”œâ”€â”€ NfcReceiver.kt           # NFC æ ‡ç­¾å¹¿æ’­
â”‚       â”‚   â”‚   â”œâ”€â”€ MediaButtonReceiver.kt   # åª’ä½“æŒ‰é”®å¹¿æ’­
â”‚       â”‚   â”‚   â”œâ”€â”€ MediaMountReceiver.kt    # åª’ä½“æŒ‚è½½å¹¿æ’­
â”‚       â”‚   â”‚   â”œâ”€â”€ SystemEventReceiver.kt   # ç³»ç»Ÿäº‹ä»¶å¹¿æ’­
â”‚       â”‚   â”‚   â””â”€â”€ WifiReceiver.kt          # WiFi çŠ¶æ€å¹¿æ’­
â”‚       â”‚   â”œâ”€â”€ observer/
â”‚       â”‚   â”‚   â”œâ”€â”€ ContentObserverManager.kt # å†…å®¹è§‚å¯Ÿè€…ç®¡ç†
â”‚       â”‚   â”‚   â””â”€â”€ FileObserverManager.kt    # æ–‡ä»¶ç³»ç»Ÿè§‚å¯Ÿè€…
â”‚       â”‚   â”œâ”€â”€ account/
â”‚       â”‚   â”‚   â”œâ”€â”€ FwAuthenticator.kt       # è´¦æˆ·è®¤è¯å™¨
â”‚       â”‚   â”‚   â”œâ”€â”€ FwSyncAdapter.kt         # åŒæ­¥é€‚é…å™¨
â”‚       â”‚   â”‚   â”œâ”€â”€ AuthenticatorService.kt  # è®¤è¯æœåŠ¡
â”‚       â”‚   â”‚   â”œâ”€â”€ SyncService.kt           # åŒæ­¥æœåŠ¡
â”‚       â”‚   â”‚   â””â”€â”€ StubContentProvider.kt   # åŒæ­¥ç”¨ Provider
â”‚       â”‚   â”œâ”€â”€ strategy/
â”‚       â”‚   â”‚   â”œâ”€â”€ FwJobService.kt          # JobScheduler ç­–ç•¥
â”‚       â”‚   â”‚   â”œâ”€â”€ FwWorker.kt              # WorkManager ç­–ç•¥
â”‚       â”‚   â”‚   â”œâ”€â”€ AlarmStrategy.kt         # AlarmManager ç­–ç•¥
â”‚       â”‚   â”‚   â”œâ”€â”€ OnePixelActivity.kt      # 1 åƒç´  Activity
â”‚       â”‚   â”‚   â”œâ”€â”€ LockScreenActivity.kt    # é”å± Activityï¼ˆæ–°å¢ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ FloatWindowManager.kt    # æ‚¬æµ®çª—ç®¡ç†ï¼ˆæ–°å¢ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ BatteryOptimizationManager.kt  # ç”µæ± ä¼˜åŒ–ç®¡ç†ï¼ˆæ–°å¢ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ VendorIntegrationAnalyzer.kt   # å‚å•†é›†æˆåˆ†æï¼ˆæ–°å¢ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ FwAccessibilityService.kt      # æ— éšœç¢æœåŠ¡
â”‚       â”‚   â”‚   â”œâ”€â”€ FwNotificationListenerService.kt # é€šçŸ¥ç›‘å¬æœåŠ¡
â”‚       â”‚   â”‚   â”œâ”€â”€ ProcessPriorityManager.kt # è¿›ç¨‹ä¼˜å…ˆçº§ç®¡ç†
â”‚       â”‚   â”‚   â””â”€â”€ forcestop/               # æ— æ³•å¼ºåˆ¶åœæ­¢ç­–ç•¥ï¼ˆC++ å®ç°ï¼‰
â”‚       â”‚   â”‚       â”œâ”€â”€ ForceStopResistance.kt    # ç­–ç•¥å…¥å£ï¼ˆè°ƒç”¨ Nativeï¼‰
â”‚       â”‚   â”‚       â”œâ”€â”€ AssistService1/2/3.kt     # è¾…åŠ©è¿›ç¨‹æœåŠ¡
â”‚       â”‚   â”‚       â”œâ”€â”€ ProcessUtils.kt           # è¿›ç¨‹å·¥å…·ç±»
â”‚       â”‚   â”‚       â”œâ”€â”€ HiddenApiBypass.kt        # éšè— API ç»•è¿‡
â”‚       â”‚   â”‚       â”œâ”€â”€ ForceStopReceiver.kt      # å”¤é†’å¹¿æ’­æ¥æ”¶å™¨
â”‚       â”‚   â”‚       â””â”€â”€ FwInstrumentation.kt      # Instrumentation ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ mediaroute/                # MediaRoute ä¿æ´»æ¨¡å—ï¼ˆæ–°å¢ v2.2.0ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ FwMediaRouteManager.kt       # æ¨¡å—ç»Ÿä¸€ç®¡ç†å™¨
â”‚       â”‚   â”‚   â”œâ”€â”€ FwMediaRouteProviderService.kt # MediaRoute æœåŠ¡
â”‚       â”‚   â”‚   â”œâ”€â”€ FwMediaRoute2ProviderService.kt # MediaRoute2 æœåŠ¡ (Android 11+)
â”‚       â”‚   â”‚   â”œâ”€â”€ FwMediaRouteProvider.kt      # è‡ªå®šä¹‰è·¯ç”±æä¾›è€…
â”‚       â”‚   â”‚   â”œâ”€â”€ FwMediaRouteNative.kt        # Native å±‚ JNI æ¥å£
â”‚       â”‚   â”‚   â””â”€â”€ FwMediaActivity.kt           # åª’ä½“æ„å›¾å¤„ç† Activity
â”‚       â”‚   â”œâ”€â”€ native/
â”‚       â”‚   â”‚   â””â”€â”€ FwNative.kt              # Native å±‚ JNI æ¥å£
â”‚       â”‚   â””â”€â”€ util/
â”‚       â”‚       â”œâ”€â”€ ServiceStarter.kt        # æœåŠ¡å¯åŠ¨å™¨
â”‚       â”‚       â””â”€â”€ FwLog.kt                 # æ—¥å¿—å·¥å…·
â”‚       â”œâ”€â”€ cpp/                             # Native C++ å±‚
â”‚       â”‚   â”œâ”€â”€ CMakeLists.txt               # CMake æ„å»ºé…ç½®
â”‚       â”‚   â”œâ”€â”€ fw_daemon.cpp                # å®ˆæŠ¤è¿›ç¨‹ï¼ˆforkï¼‰
â”‚       â”‚   â”œâ”€â”€ fw_process.cpp               # è¿›ç¨‹ç®¡ç†ï¼ˆOOM adjï¼‰
â”‚       â”‚   â”œâ”€â”€ fw_socket.cpp                # Socket é€šä¿¡
â”‚       â”‚   â”œâ”€â”€ fw_jni.cpp                   # JNI å…¥å£
â”‚       â”‚   â”œâ”€â”€ fw_force_stop.cpp            # æ— æ³•å¼ºåˆ¶åœæ­¢æ ¸å¿ƒå®ç°
â”‚       â”‚   â”œâ”€â”€ binder/                      # Binder ç›´æ¥è°ƒç”¨
â”‚       â”‚   â”‚   â”œâ”€â”€ common.h                 # å…¬å…±å®šä¹‰
â”‚       â”‚   â”‚   â”œâ”€â”€ cParcel.cpp/h            # Parcel æ•°æ®å°è£…
â”‚       â”‚   â”‚   â””â”€â”€ data_transact.cpp/h      # Binder äº‹åŠ¡å¤„ç†
â”‚       â”‚   â””â”€â”€ utils/                       # å·¥å…·ç±»
â”‚       â”‚       â”œâ”€â”€ String16.cpp/h           # UTF-16 å­—ç¬¦ä¸²
â”‚       â”‚       â”œâ”€â”€ Unicode.cpp/h            # Unicode ç¼–è§£ç 
â”‚       â”‚       â””â”€â”€ SharedBuffer.cpp/h       # å…±äº«ç¼“å†²åŒº
â”‚       â”‚   â””â”€â”€ mediaroute/                  # MediaRoute Native å±‚ï¼ˆæ–°å¢ v2.2.0ï¼‰
â”‚       â”‚       â”œâ”€â”€ CMakeLists.txt           # CMake æ„å»ºé…ç½®
â”‚       â”‚       â””â”€â”€ fw_mediaroute_jni.cpp    # JNI å®ç°ï¼ˆæœåŠ¡çŠ¶æ€ç›‘æ§ã€å¿ƒè·³ï¼‰
â”‚       â””â”€â”€ res/
â”‚           â””â”€â”€ xml/
â”‚               â”œâ”€â”€ authenticator.xml        # è´¦æˆ·è®¤è¯é…ç½®
â”‚               â”œâ”€â”€ syncadapter.xml          # åŒæ­¥é€‚é…å™¨é…ç½®
â”‚               â”œâ”€â”€ nfc_tech_list.xml        # NFC æŠ€æœ¯åˆ—è¡¨
â”‚               â””â”€â”€ accessibility_service_config.xml # æ— éšœç¢æœåŠ¡é…ç½®
â”‚
â”œâ”€â”€ build.gradle.kts               # æ ¹é¡¹ç›®æ„å»ºè„šæœ¬
â”œâ”€â”€ settings.gradle.kts            # é¡¹ç›®è®¾ç½®
â””â”€â”€ gradle/libs.versions.toml      # ä¾èµ–ç‰ˆæœ¬ç®¡ç†
```

---

## å‚å•†é€‚é…

| å‚å•† | ç‰¹æ®Šé™åˆ¶ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|---------|
| å°ç±³ (MIUI) | è‡ªå¯åŠ¨ç®¡ç†ã€ç”µæ± ä¼˜åŒ– | å¼•å¯¼ç”¨æˆ·å¼€å¯è‡ªå¯åŠ¨æƒé™ |
| åä¸º (EMUI) | é«˜çº§ç”µæ± ç®¡ç† | å¼•å¯¼ç”¨æˆ·å…³é—­ç”µæ± ä¼˜åŒ– |
| OPPO (ColorOS) | åå°å†»ç»“ | å¼•å¯¼ç”¨æˆ·æ·»åŠ çœç”µç™½åå• |
| vivo (Funtouch) | iç®¡å®¶é™åˆ¶ | å¼•å¯¼ç”¨æˆ·å¼€å¯åå°è¿è¡Œæƒé™ |
| ä¸‰æ˜Ÿ (OneUI) | è®¾å¤‡ç»´æŠ¤ä¼˜åŒ– | ç›¸å¯¹å®½æ¾ |
| Google (Pixel) | Doze æ¨¡å¼ä¸¥æ ¼ | è¯·æ±‚ `REQUEST_IGNORE_BATTERY_OPTIMIZATIONS`ï¼Œä½¿ç”¨é«˜ä¼˜å…ˆçº§ FCM æ¶ˆæ¯ã€‚ |
| ä¼ éŸ³ (Tecno) | åå°ç®¡ç†ç±»ä¼¼åŸç”Ÿï¼Œä½†æœ‰å†…å­˜æ¸…ç† | å¼•å¯¼ç”¨æˆ·é”å®šåº”ç”¨ï¼ŒåŠ å…¥è‡ªå¯åŠ¨åˆ—è¡¨ã€‚ |

### å‚å•†è‡ªå¯åŠ¨è®¾ç½®å…¥å£

```kotlin
// è‡ªåŠ¨æ‰“å¼€å½“å‰å‚å•†çš„è‡ªå¯åŠ¨è®¾ç½®
AutoStartPermissionManager.openAutoStartSettings(context)

// è·å–å¼•å¯¼æ–‡æ¡ˆ
val guideText = AutoStartPermissionManager.getGuideText()
// è¿”å›ï¼šè¯·åœ¨ã€Œè‡ªå¯åŠ¨ç®¡ç†ã€ä¸­å¼€å¯æœ¬åº”ç”¨çš„è‡ªå¯åŠ¨æƒé™
```

---

## æƒé™è¯´æ˜

### Manifest æƒé™ï¼ˆè‡ªåŠ¨æˆäºˆï¼‰

```xml
<!-- å‰å°æœåŠ¡ -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />

<!-- è“ç‰™ -->
<uses-permission android:name="android.permission.BLUETOOTH" />
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />

<!-- NFC -->
<uses-permission android:name="android.permission.NFC" />

<!-- ç½‘ç»œ -->
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.INTERNET" />

<!-- ç”µæº -->
<uses-permission android:name="android.permission.WAKE_LOCK" />
<uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />

<!-- é—¹é’Ÿ -->
<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
<uses-permission android:name="android.permission.USE_EXACT_ALARM" />

<!-- å¼€æœºå¹¿æ’­ -->
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />

<!-- è´¦æˆ·åŒæ­¥ -->
<uses-permission android:name="android.permission.GET_ACCOUNTS" />
<uses-permission android:name="android.permission.READ_SYNC_SETTINGS" />
<uses-permission android:name="android.permission.WRITE_SYNC_SETTINGS" />

<!-- æ‚¬æµ®çª— -->
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />

<!-- é”å±æ˜¾ç¤º -->
<uses-permission android:name="android.permission.DISABLE_KEYGUARD" />
<uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" />
```

### è¿è¡Œæ—¶æƒé™ï¼ˆéœ€ç”¨æˆ·æˆäºˆï¼‰

```kotlin
// Android 12+ è“ç‰™è¿æ¥æƒé™
Manifest.permission.BLUETOOTH_CONNECT

// Android 13+ é€šçŸ¥æƒé™
Manifest.permission.POST_NOTIFICATIONS

// å­˜å‚¨æƒé™ï¼ˆç”¨äº ContentObserverï¼‰
Manifest.permission.READ_MEDIA_IMAGES
Manifest.permission.READ_MEDIA_VIDEO
Manifest.permission.READ_MEDIA_AUDIO

// è”ç³»äººæƒé™ï¼ˆç”¨äº ContentObserverï¼‰
Manifest.permission.READ_CONTACTS

// çŸ­ä¿¡æƒé™ï¼ˆç”¨äº ContentObserverï¼‰
Manifest.permission.READ_SMS

// æ‚¬æµ®çª—æƒé™
Settings.canDrawOverlays(context)
```

---

## æ ¸å¿ƒåŸç†

### ä¸ºä»€ä¹ˆé…·ç‹—èƒ½è¢«è“ç‰™å”¤é†’ï¼Ÿ

| æœºåˆ¶ | è¯´æ˜ |
|-----|------|
| é™æ€å¹¿æ’­æ¥æ”¶å™¨ | åœ¨ `AndroidManifest.xml` ä¸­é™æ€æ³¨å†Œè“ç‰™å¹¿æ’­ |
| MediaSession | åˆ›å»ºåª’ä½“ä¼šè¯è®©ç³»ç»Ÿè®¤ä¸ºè¿™æ˜¯åª’ä½“åº”ç”¨ |
| å‰å°æœåŠ¡ç±»å‹ | å£°æ˜ `foregroundServiceType="mediaPlayback"` |
| æ°¸ä¸ stopped | æœ‰å¸¸é©»ç»„ä»¶çš„åº”ç”¨ä¸ä¼šè¿›å…¥çœŸæ­£çš„ stopped çŠ¶æ€ |

### ä¸ºä»€ä¹ˆå¢¨è¿¹å¤©æ°”"æ°¸ç”Ÿä¸æ­»"ï¼Ÿ

| æœºåˆ¶ | è¯´æ˜ |
|-----|------|
| å‚å•†ç™½åå• | ä¸å‚å•†ç­¾ç½²å•†ä¸šåˆä½œï¼Œè¢«åŠ å…¥ç³»ç»Ÿçº§ç™½åå• |
| æ¨é€é€šé“ | é›†æˆå‚å•†æ¨é€ SDKï¼Œæ¨é€åˆ°è¾¾æ—¶æ‹‰èµ·åº”ç”¨ |
| é¢„è£…åˆä½œ | é¢„è£…åº”ç”¨æœ‰ç‰¹æ®Šç­¾åå’Œæƒé™ |
| é”å±åŠŸèƒ½ | æä¾›"é”å±å¤©æ°”"ï¼Œä¿æŒå‰å°çŠ¶æ€ |

### å¼ºåˆ¶åœæ­¢ vs è¿›ç¨‹è¢«æ€

| æƒ…å†µ | FLAG_STOPPED | å¹¿æ’­æ¥æ”¶å™¨ | ä¿æ´»æ•ˆæœ |
|-----|-------------|-----------|---------|
| è¿›ç¨‹è¢«æ€ï¼ˆå†…å­˜ä¸è¶³ï¼‰ | ä¸è®¾ç½® | å¯æ¥æ”¶ | å¯è¢«å”¤é†’ |
| å¼ºåˆ¶åœæ­¢ï¼ˆForce Stopï¼‰ | è®¾ç½® | è¢«ç¦ç”¨ | æ— æ³•å”¤é†’ |
| ç”¨æˆ·ä¸»åŠ¨æ€æ­»ï¼ˆæœ€è¿‘ä»»åŠ¡ï¼‰ | ä¸è®¾ç½® | å¯æ¥æ”¶ | å¯è¢«å”¤é†’ |

---

## ä½¿ç”¨æ–¹æ³•

### 1. æ·»åŠ ä¾èµ–

```kotlin
// settings.gradle.kts
include(":framework")

// app/build.gradle.kts
dependencies {
    implementation(project(":framework"))
}
```

### 2. åˆå§‹åŒ–

```kotlin
class MyApp : Application() {
    override fun onCreate() {
        super.onCreate()
        Fw.init(this)
    }
}
```

### 3. æ„å»ºè¿è¡Œ

**Debug æ„å»ºï¼š**

```bash
./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

**Release æ„å»ºï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰ï¼š**

```bash
# ä¸€é”®æ‰“åŒ…ï¼Œè‡ªåŠ¨ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„ Release APK å’Œ mapping æ–‡ä»¶
./gradlew buildTimestampedReleaseApk

# è¾“å‡ºè·¯å¾„ï¼šrelease/app-202512101118.apk
#           release/mapping-202512101118.txt
```

**è‡ªå®šä¹‰ Gradle Tasksï¼š**

| Task | è¯´æ˜ |
|------|------|
| `buildTimestampedReleaseApk` | æ„å»º Release APKï¼Œè¾“å‡ºåˆ°æ ¹ç›®å½• `release/` æ–‡ä»¶å¤¹ï¼ŒåŒ…å« APK å’Œ mapping æ–‡ä»¶ |
| `generateProguardDictionary` | ç”Ÿæˆæ–°çš„éšæœºæ··æ·†å­—å…¸ï¼ˆè­¦å‘Šï¼šä¼šè¦†ç›–ç°æœ‰å­—å…¸ï¼‰ |

### 4. æµ‹è¯•è“ç‰™å”¤é†’

```bash
# æ¨¡æ‹Ÿè“ç‰™è®¾å¤‡è¿æ¥
./test_bluetooth_broadcast.sh connect

# æ¨¡æ‹Ÿè“ç‰™è€³æœºè¿æ¥
./test_bluetooth_broadcast.sh headset

# æ¨¡æ‹ŸéŸ³é¢‘è¾“å‡ºå˜åŒ–
./test_bluetooth_broadcast.sh noisy
```

### 5. æŸ¥çœ‹æ—¥å¿—

```bash
adb logcat | grep -E "(Fw|BluetoothReceiver|UsbReceiver|NfcReceiver)"
```

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆå¼ºåˆ¶åœæ­¢ååº”ç”¨ä¸èƒ½è¢«å”¤é†’ï¼Ÿ**

å¼ºåˆ¶åœæ­¢ä¼šè®¾ç½® `FLAG_STOPPED`ï¼Œå¯¼è‡´æ‰€æœ‰é™æ€å¹¿æ’­æ¥æ”¶å™¨è¢«ç¦ç”¨ã€‚è¿™æ˜¯ Android çš„å®‰å…¨æœºåˆ¶ï¼Œæ— æ³•ç»•è¿‡ã€‚

**Q: ä¸ºä»€ä¹ˆæŸäº›å‚å•†æ‰‹æœºæ•ˆæœä¸å¥½ï¼Ÿ**

å›½äº§å‚å•†ï¼ˆå°ç±³ã€åä¸ºã€OPPOã€vivoï¼‰æœ‰é¢å¤–çš„åå°ç®¡ç†æœºåˆ¶ï¼Œéœ€è¦å¼•å¯¼ç”¨æˆ·ï¼š

1. å¼€å¯è‡ªå¯åŠ¨æƒé™
2. å…³é—­ç”µæ± ä¼˜åŒ–
3. æ·»åŠ çœç”µç™½åå•
4. é”å®šæœ€è¿‘ä»»åŠ¡å¡ç‰‡

**Q: Android 14+ å‰å°æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Ÿ**

éœ€è¦å£°æ˜å¯¹åº”çš„å‰å°æœåŠ¡ç±»å‹æƒé™ï¼š
```xml
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
```

**Q: Native å®ˆæŠ¤è¿›ç¨‹æœ‰æ•ˆå—ï¼Ÿ**

Native å®ˆæŠ¤è¿›ç¨‹ï¼ˆforkï¼‰åœ¨æ™®é€šåº”ç”¨ä¸­æ•ˆæœæœ‰é™ï¼Œå› ä¸ºï¼š

1. å¼ºåˆ¶åœæ­¢ä¼šæ€æ­»æ•´ä¸ªè¿›ç¨‹ç»„
2. éƒ¨åˆ†å‚å•†å¯¹ Native å®ˆæŠ¤æœ‰é¢å¤–æ£€æµ‹
3. SELinux é™åˆ¶ am å‘½ä»¤æ‰§è¡Œ

ä½†é…åˆ Java å±‚åŒè¿›ç¨‹å¯ä»¥æé«˜å­˜æ´»ç‡ã€‚

**Q: å¦‚ä½•åƒå¢¨è¿¹å¤©æ°”ä¸€æ ·"æ°¸ç”Ÿä¸æ­»"ï¼Ÿ**

æ™®é€šåº”ç”¨å¾ˆéš¾è¾¾åˆ°å¢¨è¿¹å¤©æ°”çš„æ•ˆæœï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ï¼š

1. ä¸å‚å•†æœ‰å•†ä¸šåˆä½œï¼Œè¢«åŠ å…¥ç³»ç»Ÿçº§ç™½åå•
2. æ˜¯é¢„è£…åº”ç”¨ï¼Œæœ‰ç‰¹æ®Šæƒé™
3. é›†æˆäº†å‚å•†æ¨é€ SDK

å»ºè®®ï¼šé›†æˆå‚å•†æ¨é€ SDK + å¼•å¯¼ç”¨æˆ·å¼€å¯è‡ªå¯åŠ¨æƒé™ + è¯·æ±‚ç”µæ± ä¼˜åŒ–è±å…ã€‚

---

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

---

## æ›´æ–°æ—¥å¿—

### v2.2.0 (2025-02) ğŸ†•

**æ–°å¢ MediaRoute ä¿æ´»ç­–ç•¥** - é…·ç‹—éŸ³ä¹æ ¸å¿ƒä¿æ´»æŠ€æœ¯

- æ–°å¢ `FwMediaRouteProviderService` - å‘ç³»ç»Ÿ MediaRouter æ³¨å†Œåª’ä½“è·¯ç”±æä¾›è€…
- æ–°å¢ `FwMediaRoute2ProviderService` - Android 11+ MediaRouter2 API æ”¯æŒ
- æ–°å¢ `FwMediaRouteNative` - C++ å±‚æœåŠ¡çŠ¶æ€ç›‘æ§ã€å¿ƒè·³æ£€æµ‹ã€WakeLock ç®¡ç†
- æ–°å¢ `FwMediaRouteManager` - ç»Ÿä¸€ç®¡ç†æ¨¡å—ç”Ÿå‘½å‘¨æœŸ
- æ–°å¢ `FwMediaActivity` - åª’ä½“æ„å›¾å¤„ç† Activity
- é…ç½®é¡¹ï¼š`enableMediaRouteProvider`ã€`enableMediaRoute2Provider`ã€`enableMediaIntentActivity`

### v2.1.0 (2025-01)

**æ–°å¢æ— æ³•å¼ºåˆ¶åœæ­¢ç­–ç•¥** - 5ms æ—¶é—´å·®ç«äº‰æŠ€æœ¯

- æ–°å¢ `ForceStopResistance` - å¤šè¿›ç¨‹æ–‡ä»¶é”ç›‘æ§
- æ–°å¢ `AppProcessLauncher` - app_process å‘½ä»¤æ‹‰æ´»
- æ–°å¢ `AmsBinderInvoker` - C++ ç›´æ¥è°ƒç”¨ AMS Binder
- æ–°å¢ `FwInstrumentation` - Instrumentation æ‹‰æ´»
- Native å±‚ Binder ç›´æ¥è°ƒç”¨å®ç°ï¼ˆ< 1ms å“åº”ï¼‰
- é€‚ç”¨èŒƒå›´ï¼šAndroid 5.0 - 12.0

### v2.0.0 (2025-01)

**æ¶æ„å‡çº§**

- å‡çº§è‡³ AGP 8.14.3ã€Kotlin 2.2.21ã€JDK 21
- æ”¯æŒ Android 16 (API 36.1)
- é€‚é… 16KB é¡µé¢å¤§å°ï¼ˆGoogle Play 2026 è¦æ±‚ï¼‰
- æ–°å¢ `LockScreenActivity` - é”å± Activityï¼ˆç±»ä¼¼å¢¨è¿¹å¤©æ°”é”å±å¤©æ°”ï¼‰
- æ–°å¢ `FloatWindowManager` - æ‚¬æµ®çª—ä¿æ´»
- æ–°å¢ `BatteryOptimizationManager` - ç”µæ± ä¼˜åŒ–è±å…ç®¡ç†
- æ–°å¢ `VendorIntegrationAnalyzer` - å‚å•†é›†æˆåˆ†æå·¥å…·
- æ–°å¢ `AutoStartPermissionManager` - å‚å•†è‡ªå¯åŠ¨æƒé™ç®¡ç†

### v1.0.0 (2024-12)

- åˆå§‹ç‰ˆæœ¬
- æ”¯æŒ 20+ ç§ä¿æ´»ç­–ç•¥
- åŒ…å« Native C++ å±‚å®ˆæŠ¤è¿›ç¨‹
- æ”¯æŒ JobSchedulerã€WorkManagerã€AlarmManager å®šæ—¶å”¤é†’
- æ”¯æŒè“ç‰™ã€USBã€NFCã€åª’ä½“æŒ‰é”®ç­‰å¹¿æ’­ç›‘å¬
- æ”¯æŒè´¦æˆ·åŒæ­¥ã€å†…å®¹è§‚å¯Ÿè€…ç­–ç•¥
- æ”¯æŒ Java åŒè¿›ç¨‹å®ˆæŠ¤

---

## License

```text
                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   Copyright 2024-2025 KeepLiveService Contributors

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
```

**ç®€å•è¯´æ˜ï¼š**

- âœ… å…è®¸å•†ä¸šä½¿ç”¨
- âœ… å…è®¸ä¿®æ”¹
- âœ… å…è®¸åˆ†å‘
- âœ… å…è®¸ç§æœ‰ä½¿ç”¨
- âœ… å…è®¸ä¸“åˆ©ä½¿ç”¨
---

## å…è´£å£°æ˜

æœ¬é¡¹ç›®ä»…ä¾›å®‰å…¨ç ”ç©¶å’Œå­¦ä¹ ä½¿ç”¨ã€‚ä½¿ç”¨è€…åº”éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œä¸å¾—å°†æœ¬é¡¹ç›®ç”¨äºä»»ä½•éæ³•ç”¨é€”ã€‚ä½œè€…ä¸å¯¹ä½¿ç”¨æœ¬é¡¹ç›®é€ æˆçš„ä»»ä½•åæœè´Ÿè´£ã€‚

---

## è‡´è°¢

- æ„Ÿè°¢æ‰€æœ‰ä¸º Android å®‰å…¨ç ”ç©¶åšå‡ºè´¡çŒ®çš„ç ”ç©¶è€…
- æ„Ÿè°¢å¼€æºç¤¾åŒºçš„æ”¯æŒ

---

**Star â­ è¿™ä¸ªé¡¹ç›®å¦‚æœå¯¹ä½ æœ‰å¸®åŠ©ï¼**

![äºŒç»´ç ](https://github.com/Pangu-Immortal/Pangu-Immortal/blob/main/getqrcode.png)

ğŸ”¥ **Telegram ç¾¤ç»„**ï¼š [ç‚¹å‡»åŠ ç¾¤è®¨è®ºï¼Œè¿™é‡Œåªæ˜¯å†°å±±ä¸€è§’ã€‚](https://t.me/+V7HSo1YNzkFkY2M1)

---
ï¼ˆæ‰€æœ‰åŠŸèƒ½å‡æä¾›å¯¹ Android 16 ç‰ˆæœ¬çš„é€‚é…ï¼Œæ·»åŠ è”ç³»æ—¶è¯·å¤‡æ³¨éœ€æ±‚ï¼‰

- **åº”ç”¨è‡ªå¯åŠ¨**ï¼šåº”ç”¨å®‰è£…åæ— éœ€ç”¨æˆ·ç‚¹å‡»å³å¯è‡ªåŠ¨å¯åŠ¨ã€‚
- **æš—åˆ· H5 å¹¿å‘Š**ï¼šå·å·åˆ· ADXã€adsense ç­‰ H5 å¹¿å‘Šï¼Œå¯ä»¥å¼€å¯ 20+ view åŒæ—¶åˆ·ã€‚
- **æ— æƒé™åå°å¼¹å‡º Activity**ï¼šæ— éœ€æƒé™å³å¯åœ¨åå°ä»»æ„æ—¶æœºå¼¹å‡º Activityï¼Œæ— éœ€é”å±ã€‚
- **åº”ç”¨ä¿æ´»**ï¼šåº”ç”¨å¯åœ¨å¤šæ¬¡å¼ºåˆ¶åœæ­¢æ“ä½œåä»ä¿æŒè¿è¡Œï¼Œå®Œç¾æŠµæŠ—å¼ºåˆ¶åœæ­¢æ“ä½œã€‚
- **åº”ç”¨æ‹‰æ´»**ï¼šåœ¨åº”ç”¨å½»åº•æ­»äº¡çš„çŠ¶æ€ä¸‹ï¼Œå¯åœ¨15åˆ†é’Ÿå†…å”¤é†’è‡ªèº«ã€‚
- **é˜²å¸è½½**ï¼šé˜²æ­¢ç”¨æˆ·å¸è½½åº”ç”¨ï¼Œç‚¹å‡»å¸è½½æ— ååº”ã€‚
- **æ— æ„ŸçŸ¥å¸è½½ç«å“**ï¼šå¯æ— æ„ŸçŸ¥åœ°å¸è½½æ‰‹æœºä¸­ä»»æ„åº”ç”¨ã€‚
- **éšè—æ¡Œé¢å›¾æ ‡**ï¼šåº”ç”¨å®‰è£…åç«‹å³éšè—è‡ªèº«ï¼Œæˆ–åœ¨éœ€è¦æ—¶éšæ—¶éšè—ï¼Œæ”¯æŒ Android 16ã€‚
- **é©¬ç”²åŒ…æœåŠ¡**ï¼šå½»åº•è§£å†³å…³è”é—®é¢˜ï¼Œä¸ºæ‰¹é‡é©¬ç”²åŒ…æä¾›æœåŠ¡ã€‚
- **æŠ¥ç—…æ¯’ä¼˜åŒ–**ï¼šæ— éœ€é‡æ–°æ‰“åŒ…ï¼Œå‡€åŒ–åº”ç”¨ï¼Œå¤„ç†æ‰€æœ‰åº”ç”¨çš„æŠ¥æ¯’é—®é¢˜ã€‚
- **è´¦å·éš”ç¦»**ï¼šä¸ºå¼€å‘è€…æä¾›å®Œå–„çš„è´¦å·éš”ç¦»ä½“ç³»ï¼Œé˜²æ­¢è´¦å·å…³è”ã€‚
- **IP æ¼‚ç§»**ï¼šæ”¯æŒæ‹‰å–é«˜ eCPM åœ°åŒºçš„ AdMob å¹¿å‘Šã€‚
- **æ¨¡æ‹Ÿ iOS**ï¼šæ”¯æŒ Android è®¾å¤‡æ¨¡æ‹Ÿå¹¶æ‹‰å– iOS çš„ AdMob å¹¿å‘Šï¼Œå¤§å¹…æé«˜ eCPMã€‚
- **æœºå‹æ¨¡æ‹Ÿå·¥å…·**ï¼šæ”¯æŒæ‰¹é‡åˆ·ä¸‹è½½é‡ï¼Œå¯æ— æˆæœ¬å¿«é€Ÿåˆ·ç™¾ä¸‡ä¸‹è½½é‡ï¼Œè¿…é€Ÿæé«˜å•†åº—æ’åã€‚
- **å›½å†…æœºå‹ä¿æ´»**ï¼šä¸ºè¿åŠ¨ç±»ã€å¤–å–ç±»ã€èŠå¤©ç±»ç­‰åº”ç”¨å®ç°æ°¸ç”Ÿä¸æ­»ï¼Œä¸è¢«ç³»ç»Ÿæ€æ­»ï¼Œå·²ä¸ºå¤šæ¬¾åº”ç”¨æ¥å…¥ã€‚
- **é˜²æŠ“åŒ…å¤„ç†**ï¼šæ•°æ®è„±æ•ï¼Œé€‚ç”¨äºæ£‹ç‰Œç±»å¤§è§„æ¨¡ä¸Šæ¶ç­‰æ“ä½œã€‚
- **å¤šå¼€ã€åŒå¼€å·¥å…·**ï¼šæ”¯æŒæ— é™åˆ†èº«ç­‰åŠŸèƒ½ã€‚
- **å¤§æ¨¡å‹å®šåˆ¶å¼€å‘**ï¼šæä¾›ç§æœ‰æ•°æ®è®­ç»ƒã€NSFW æ¨¡å‹å¼€å‘ã€æˆäººæ¨¡å‹åˆ¶ä½œã€æˆäººè¯æœ¯ã€æˆäººç…§ç‰‡ã€æˆäººè§†é¢‘ç­‰ç§æœ‰åŒ–ä¸“å±å¤§æ¨¡å‹è®­ç»ƒåˆ¶ä½œã€‚
- **æ•°å­—äººã€æ¢è„¸ã€å›¾ç”Ÿå›¾ã€å›¾ç”Ÿè§†é¢‘**ï¼šåˆ¶ä½œæ˜æ˜Ÿã€è‡ªå·±ã€å®¶äººçš„æ•°å­—äººï¼Œè€ç…§ç‰‡å¤æ´»ï¼Œä¸å·²é€å»çš„äº²äººå¯¹è¯ã€‚
- **äº‘æ¸¸æˆã€äº‘æ‰‹æœºæ­å»º**ï¼šæä¾›å…¨å¥—äº‘ç«¯å®¹å™¨æ–¹æ¡ˆï¼Œæ¶µç›–äº‘åŸç”Ÿ GPUã€å®šåˆ¶åŒ–æœåŠ¡å™¨ã€å…¨å…‰ç½‘ç»œã€ååŒæ¸²æŸ“ã€AI å†…å®¹ç”Ÿæˆã€äº‘åŸç”Ÿå·¥å…·åŒ…ç­‰æ ¸å¿ƒæŠ€æœ¯è·¯å¾„ã€‚
- **å®šåˆ¶åŒ–æ’­æ”¾å™¨**ï¼šæä¾›åŠ å¯†æ’­æ”¾å™¨ã€3D æ’­æ”¾å™¨ã€äº‘æ’­æ”¾å™¨ç­‰ï¼Œå¯ä¸ºä»»æ„è§†é¢‘ç¼–è§£ç æä¾›å®šåˆ¶æœåŠ¡ï¼Œä¸º ARã€VRã€MR åœºæ™¯æä¾›æœåŠ¡ã€‚
- **æ»¤é•œå®šåˆ¶**ï¼šæä¾›è§†é¢‘ã€ç›¸æœºã€å›¾ç‰‡ç­‰æ»¤é•œå¤„ç†ï¼Œå¯æ ¹æ®ç«å“æ•ˆæœè¿›è¡Œæ¨¡ä»¿ã€‚
- **AI å¤šåœºæ™¯å®šåˆ¶**ï¼šå¤šå¹´ AI è¡Œä¸šç»éªŒï¼Œå¯ä¸ºå°å›¢é˜Ÿæä¾›å®šåˆ¶åŒ–çš„ AI æœåŠ¡ã€‚
- **ROM å®šåˆ¶**ï¼šæä¾›å„ç±»å®šåˆ¶åŒ–åŠŸèƒ½çš„ Android ç³»ç»Ÿï¼Œä¹Ÿå¯æä¾›è½¦è½½ç³»ç»Ÿçš„å®šåˆ¶åŒ–ï¼Œæä¾›è½¯ç¡¬ä»¶äº¤äº’çš„å¤–åŒ…æœåŠ¡ã€‚

---

## â­ Star è¶‹åŠ¿

<a href="https://star-history.com/#Pangu-Immortal/KeepLiveService&Date">
 <picture>
   <source media="(prefers-color-scheme: dark)" srcset="https://api.star-history.com/svg?repos=Pangu-Immortal/KeepLiveService&type=Date&theme=dark" />
   <source media="(prefers-color-scheme: light)" srcset="https://api.star-history.com/svg?repos=Pangu-Immortal/KeepLiveService&type=Date" />
   <img alt="Star History Chart" src="https://api.star-history.com/svg?repos=Pangu-Immortal/KeepLiveService&type=Date" />
 </picture>
</a>
